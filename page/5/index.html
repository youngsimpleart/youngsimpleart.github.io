<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.10.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/09/26/%E5%9B%9B%E3%80%81springBoot%20%E4%BC%98%E9%9B%85%E7%9A%84%E5%88%9B%E5%BB%BA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/09/26/%E5%9B%9B%E3%80%81springBoot%20%E4%BC%98%E9%9B%85%E7%9A%84%E5%88%9B%E5%BB%BA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/" class="post-title-link" itemprop="url">四、springBoot优雅的创建定时任务</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-09-26 16:12:02" itemprop="dateCreated datePublished" datetime="2019-09-26T16:12:02+08:00">2019-09-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-02-25 15:14:51" itemprop="dateModified" datetime="2022-02-25T15:14:51+08:00">2022-02-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/springBoot/" itemprop="url" rel="index"><span itemprop="name">springBoot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>好几天没写了，工作有点忙，最近工作刚好做一个定时任务统计的，所以就将springboot 如何创建定时任务整理了一下。<br>总的来说，springboot创建定时任务是非常简单的，不用像spring 或者springmvc 需要在xml 文件中配置，在项目启动的时候加载。spring boot 使用注解的方式就可以完全支持定时任务。<br>不过基础注解的话，可能有的需求定时任务的时间会经常变动，注解就不好修改，每次都得重新编译，所以想将定时时间存在数据库，然后项目读取数据库执行定时任务，所以就有了基于接口的定时任务。下面就分基于注解和基于接口详细讲解。</p>
<h1 id="基于注解"><a href="#基于注解" class="headerlink" title="基于注解"></a>基于注解</h1><p>pom.xml 文件不用修改，我们原本的项目就支持，其实定时器是springboot框架自带的，不用引入什么依赖。我们直接创建一个autotask 包，创建一个AutoTask类。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@EnableScheduling</span><br><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">public class AutoTask &#123;</span><br><span class="line">    @Scheduled(cron=&quot;*/6 * * * * ?&quot;)</span><br><span class="line">    private void process()&#123;</span><br><span class="line">        log.info(&quot;autoTask &quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样一个定时器就创建啦，在项目启动后，会每隔6s 打印“autoTask”的日志。是不是很简单。主要用到的两个注解就是@EnableScheduling 和 @Scheduled。<br>注解@EnableScheduling 就是开启定时任务的。哪个类的中的方法想要定期执行，就在这个类上加入这个注解。当然这个这个注解也可以加在启动类上。加在启动类上表示项目中所有的类都可以创建定时任务。<br><img src="https://img-blog.csdnimg.cn/20190926161157924.jpeg" alt="file"></p>
<p>@Scheduled 注解就是我们常见的定时器啦，后面的cron 就是定时任务表达式。在方法上注解，表示这个方法定期执行。<br><img src="https://img-blog.csdnimg.cn/20190926161158434.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"><br>不过@Scheduled 可以进行两种配置，我们熟悉的cron ,还有一种是fixedRate。比如fixedRate&#x3D;6000 表示方法每6秒钟执行一次。<br>我们来启动项目看一下，可以看到两个方法都在定期执行。<br><img src="https://img-blog.csdnimg.cn/20190926161158769.jpeg" alt="file"></p>
<h1 id="基于接口"><a href="#基于接口" class="headerlink" title="基于接口"></a>基于接口</h1><p>上面可以看到springboot 基于注解是非常方便的。但是对于频繁变动或者一个项目中有很多的定时器那就不方便管理了。所以统一将定时器信息存放在数据库中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `scheduled`;</span><br><span class="line">CREATE TABLE `scheduled`  (</span><br><span class="line">  `cron_id` varchar(30) NOT NULL PRIMARY KEY,</span><br><span class="line">  `cron_name` varchar(30) NULL,</span><br><span class="line">  `cron` varchar(30) NOT NULL</span><br><span class="line">);</span><br><span class="line">INSERT INTO `scheduled` VALUES (&#x27;1&#x27;,&#x27;定时器任务一&#x27;,&#x27;0/6 * * * * ?&#x27;);</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190926161159239.jpeg" alt="file"></p>
<p>在dao 层mapper1包下创建一个CronMapper接口，很简单的就获取cron</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public interface CronMapper &#123;</span><br><span class="line"></span><br><span class="line">    @Select(&quot;select cron from scheduled where cron_id = #&#123;id&#125;&quot;)</span><br><span class="line">    public String getCron(int id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190926161159580.jpeg" alt="file"></p>
<p>这里我们就不写service 层了。直接在autotask 包下创建一个AutoTaskFromDB类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class AutoTaskFromDB implements SchedulingConfigurer &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    protected CronMapper cronMapper;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void configureTasks(ScheduledTaskRegistrar scheduledTaskRegistrar) &#123;</span><br><span class="line"></span><br><span class="line">        scheduledTaskRegistrar.addTriggerTask(() -&gt; process(),</span><br><span class="line">                triggerContext -&gt; &#123;</span><br><span class="line">                    String cron = cronMapper.getCron(1);</span><br><span class="line">                    if (cron.isEmpty()) &#123;</span><br><span class="line">                       log.info(&quot;cron 为空&quot;);</span><br><span class="line">                    &#125;</span><br><span class="line">                    return new CronTrigger(cron).nextExecutionTime(triggerContext);</span><br><span class="line">                &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private  void process()&#123;</span><br><span class="line">        log.info(&quot;formDB &quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到也很简单，就是实现SchedulingConfigurer 这个吧接口，addTriggerTask（）是添加一个定时器。<br>process（）方法是我们需要定时执行的方法体。<br>CronTrigger(cron).nextExecutionTime(triggerContext) 就是从数据库读取的cron 创建定时器。</p>
<p>这个类我没有加上@EnableScheduling 注解，因为我在启动类上加上了，如果你们启动类上没有加，这里记得加上。</p>
<p>测试一下;下图可以看到三个定时任务都执行了，fromDB 是从数据库读取的。<br><img src="https://img-blog.csdnimg.cn/20190926161159969.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>
<h1 id="cron"><a href="#cron" class="headerlink" title="cron"></a>cron</h1><p>cron 用法网上有很多，也没有什么讲的这里就附带记录下</p>
<h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><p>cron表达式是一个字符串，分为6或7个域，每两个域之间用空格分隔，<br>其语法格式为：”秒域 分域 时域 日域 月域 周域 年域”</p>
<h2 id="取值范围"><a href="#取值范围" class="headerlink" title="取值范围"></a>取值范围</h2><p>|域名|    可取值|    可取符号（仅列部分常用）|<br>|–|–|<br>|秒域|    0<del>59的整数|      *    -    ,    &#x2F;<br>|分域|    0</del>59的整数|      *    -    ,    &#x2F;<br>|时域    |0<del>23的整数|      *    -    ,    &#x2F;<br>|日域    |1</del>31的整数|      *    -    ,    &#x2F;    ?    L<br>|月域    |1<del>12的整数或JAN</del>DEC|      *    -    ,    &#x2F;<br>|周域    |1<del>7的整数或SUN</del>SAT|  *    -    ,    &#x2F;    ?    L    #<br>|年域    |1970~2099的整数    |  *    -    ,    &#x2F;</p>
<h2 id="常例"><a href="#常例" class="headerlink" title="常例"></a>常例</h2><table>
<thead>
<tr>
<th>表达式</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>每隔5秒钟执行一次</td>
<td>*&#x2F;5  *  * *  *  ?</td>
</tr>
<tr>
<td>每隔1分钟执行一次</td>
<td>0  * &#x2F;1  * * *  ?</td>
</tr>
<tr>
<td>每天1点执行一次</td>
<td>0  0  1  *  *  ?</td>
</tr>
<tr>
<td>每天23点55分执行一次</td>
<td>0  55  23 *  * ？</td>
</tr>
<tr>
<td>每月最后一天23点执行一次</td>
<td>0  0  23  L  *  ？</td>
</tr>
<tr>
<td>每周六8点执行一次</td>
<td>0  0  8  ?  *  L</td>
</tr>
<tr>
<td>每月最后一个周五，每隔2小时执行一次</td>
<td>0  0  *&#x2F;2  ?  *  6L</td>
</tr>
<tr>
<td>每月的第三个星期五上午10:15执行一次</td>
<td>0  15  10  ? *  5#3</td>
</tr>
<tr>
<td>在每天下午2点到下午2:05期间的每1分钟执行</td>
<td>0  0-5  14  *  *  ?</td>
</tr>
<tr>
<td>表示周一到周五每天上午10:15执行</td>
<td>0  15  10  ? *  2-6</td>
</tr>
<tr>
<td>每个月的最后一个星期五上午10:15执行</td>
<td>0  15  10  ?  *  6L</td>
</tr>
<tr>
<td>每天上午10点，下午2点，4点执行一次</td>
<td>0  0  10,14,16  * * ?</td>
</tr>
<tr>
<td>朝九晚五工作时间内每半小时执行一次</td>
<td>0  0&#x2F;30  9-17  *  * ?</td>
</tr>
<tr>
<td>每个星期三中午12点执行一次</td>
<td>0  0  12  ?  *  4</td>
</tr>
<tr>
<td>每年三月的星期三的下午2:10和2:44各执行一次</td>
<td>0  10,44  14  ?  3  4</td>
</tr>
<tr>
<td>每月的第三个星期五上午10:15执行一次</td>
<td>0  15  10  ?  *  6#3</td>
</tr>
<tr>
<td>每月一日凌晨2点30执行一次</td>
<td>0  30  2  1  *  ?</td>
</tr>
<tr>
<td>每分钟的第10秒与第20秒都会执行</td>
<td>10,20  *  *  *  * ?</td>
</tr>
<tr>
<td>每月的第2个星期的周5，凌晨执行</td>
<td>0  0  0  ?  *  6#2</td>
</tr>
</tbody></table>
<h1 id="番外"><a href="#番外" class="headerlink" title="番外"></a>番外</h1><p>本来这个知识点不应该放在这里讲的，但是不多，顺带写了，刚好也能做定时器。我们项目中往往有一些需求需要在项目启动的时候就执行，那这个我们怎么实现了。其实spring boot 使用起来也非常简单，只用实现 ApplicationRunner  就好了。<br>我们在autotask 包下创建一个AutoTaskFromSpringRunner类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class AutoTaskFromSpringRunner implements ApplicationRunner &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run(ApplicationArguments args) throws Exception &#123;</span><br><span class="line">        process();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void process()&#123;</span><br><span class="line">        log.info(&quot; run ApplicationArguments&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>启动项目看一下，可以发现这个会在项目启动后执行，但是只会执行一次。</p>
<p><img src="https://img-blog.csdnimg.cn/20190926161200531.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"><br>那这个怎么用来做定时器呢？当然是结合线程来做啦，但是这个方法其实不建议，b毕竟线程很容易出问题，但是提供一种思路：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@Component</span><br><span class="line">public class AutoTaskFromSpringRunner implements ApplicationRunner &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run(ApplicationArguments args) throws Exception &#123;</span><br><span class="line">        process();</span><br><span class="line">        new Thread(() -&gt; &#123;</span><br><span class="line">            while (true) &#123;</span><br><span class="line">                process2();</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(6000);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    log.error(&quot;&#123;&#125;&quot;,e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">    private void process()&#123;</span><br><span class="line">        log.info(&quot; run ApplicationArguments&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    private void process2()&#123;</span><br><span class="line">        log.info(&quot;线程定时器&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>启动项目看下，发现也是可以起到定时器的作用的。<br><img src="https://img-blog.csdnimg.cn/20190926161201238.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>
<p>好了，就说这么多啦，今天项目的代码也同步到github 上啦。<br>github地址：<a target="_blank" rel="noopener" href="https://github.com/QuellanAn/zlflovemm">https://github.com/QuellanAn/zlflovemm</a></p>
<p>后续加油♡</p>
<p>欢迎大家关注个人公众号 “程序员爱酸奶”</p>
<p>分享各种学习资料，包含java，linux，大数据等。资料包含视频文档以及源码，同时分享本人及投递的优质技术博文。</p>
<p>如果大家喜欢记得关注和分享哟❤<br><img src="https://img-blog.csdnimg.cn/2019092616120288.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/09/21/%E4%B8%89%E3%80%81SpringBoot%20%E6%95%B4%E5%90%88mybatis%20%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E4%BB%A5%E5%8F%8A%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/09/21/%E4%B8%89%E3%80%81SpringBoot%20%E6%95%B4%E5%90%88mybatis%20%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E4%BB%A5%E5%8F%8A%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" class="post-title-link" itemprop="url">三、SpringBoot 整合mybatis 多数据源以及分库分表</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-09-21 18:41:27" itemprop="dateCreated datePublished" datetime="2019-09-21T18:41:27+08:00">2019-09-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-02-25 15:14:51" itemprop="dateModified" datetime="2022-02-25T15:14:51+08:00">2022-02-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/springBoot/" itemprop="url" rel="index"><span itemprop="name">springBoot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>说实话，这章本来不打算讲的，因为配置多数据源的网上有很多类似的教程。但是最近因为项目要用到分库分表，所以让我研究一下看怎么实现。我想着上一篇博客讲了多环境的配置，不同的环境调用不同的数据库，那接下来就将一个环境用到多个库也就讲了。所以才有了这篇文章。<br>我们先来看一下今天项目的项目结构，在上篇博客的基础上进行了一定的增改，主要是增加了一个 config 文件，在dao 中分了两个子包mapper1 和mapper2 将原先的UserMapper 移入到了 mapper1 中。好了，开始正文<br><img src="https://img-blog.csdnimg.cn/20190921184125101.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>
<h1 id="多数据源配置"><a href="#多数据源配置" class="headerlink" title="多数据源配置"></a>多数据源配置</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>在这之前，还是先说一下为什么会存在多数据源。如果项目小的话，当然是所有的数据以及逻辑处理都操作同一个库。但是当业务量大的话，就会考虑到分库了。比我会将也日志入库数据存放到单独的数据库。或者用户权限信息单独的一个库存放。这种如果只是简单的分库，一个项目中就用到2~4 个数据库的话，这种多数据源配置就有意义啦。在配置文件中配置好这几个数据源，都有唯一标识。项目在启动加载的时候都进行初始化，然后在调用的时候，想用哪个库就哪个数据源的连接实例就好了。</p>
<p>如果不整合 mybatis 的话，直接使用使用spring 自带的jdbcTemplate ，那配置多数据源，以及使用都比较简单，但是整合 mybatis 的话，就相对复杂点。我们一步一步来将讲解。  </p>
<h2 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h2><p>打开application-dev.yml 文件，添加数据源。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#开发环境</span><br><span class="line">spring:</span><br><span class="line">  # 数据源配置</span><br><span class="line">  datasource:</span><br><span class="line">    one:</span><br><span class="line">      driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">      jdbc-url: jdbc:mysql://192.168.252.53:3306/zlflovemm?characterEncoding=utf-8&amp;useSSL=false&amp;zeroDateTimeBehavior=CONVERT_TO_NULL</span><br><span class="line">      username: root</span><br><span class="line">      password: 123456</span><br><span class="line">      max-idle: 10</span><br><span class="line">      max-wait: 10000</span><br><span class="line">      min-idle: 5</span><br><span class="line">      initial-size: 5</span><br><span class="line">    two:</span><br><span class="line">      driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">      jdbc-url: jdbc:mysql://192.168.252.53:3306/zlfdb?characterEncoding=utf-8&amp;useSSL=false&amp;zeroDateTimeBehavior=CONVERT_TO_NULL</span><br><span class="line">      username: root</span><br><span class="line">      password: 123456</span><br><span class="line">      max-idle: 10</span><br><span class="line">      max-wait: 10000</span><br><span class="line">      min-idle: 5</span><br><span class="line">      initial-size: 5</span><br></pre></td></tr></table></figure>

<p>这里需要注意的是如果使用的是springboot 2.0 以上的，那么注意是 driver-class-name 和<br> jdbc-url 而不是driverClassName和url.这里是一个坑，提醒大家一下。</p>
<h2 id="配置数据源"><a href="#配置数据源" class="headerlink" title="配置数据源"></a>配置数据源</h2><p>接下来就需要我们手动的加载什么什么数据源了，我们在config中创建 DataSourcesConfig 类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class DataSourcesConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Bean(name=&quot;dbOne&quot;)</span><br><span class="line">    @ConfigurationProperties(prefix = &quot;spring.datasource.one&quot;)</span><br><span class="line">    @Primary</span><br><span class="line">    DataSource dbOne()&#123;</span><br><span class="line">        return DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean(name=&quot;dbTwo&quot;)</span><br><span class="line">    @ConfigurationProperties(prefix = &quot;spring.datasource.two&quot;)</span><br><span class="line">    DataSource dbTwo()&#123;</span><br><span class="line">        return DataSourceBuilder.create().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里定义了两个数据源的DataSource。分别是我们在配置文件中配置的one 和two 。注解@Primary 表示默认使用的数据源。</p>
<p>MyBatisConfigOne 类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@MapperScan(basePackages = &quot;com.quellan.zlflovemm.dao.mapper1&quot;,sqlSessionFactoryRef = &quot;sqlSessionFactory1&quot;,sqlSessionTemplateRef = &quot;sqlSessionTemplate1&quot;)</span><br><span class="line">public class MyBatisConfigOne &#123;</span><br><span class="line">    @Resource(name = &quot;dbOne&quot;)</span><br><span class="line">    DataSource dbOne;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @Primary</span><br><span class="line">    SqlSessionFactory sqlSessionFactory1()throws Exception &#123;</span><br><span class="line">        SqlSessionFactoryBean bean = new SqlSessionFactoryBean();</span><br><span class="line">        bean.setDataSource(dbOne);</span><br><span class="line">        return bean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">    @Bean</span><br><span class="line">    @Primary</span><br><span class="line">    SqlSessionTemplate sqlSessionTemplate1() throws Exception&#123;</span><br><span class="line">        return new SqlSessionTemplate(sqlSessionFactory1());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>MyBatisConfigTwo 类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@MapperScan(basePackages = &quot;com.quellan.zlflovemm.dao.mapper2&quot;,sqlSessionFactoryRef = &quot;sqlSessionFactory2&quot;,sqlSessionTemplateRef = &quot;sqlSessionTemplate2&quot;)</span><br><span class="line">public class MyBatisConfigTwo &#123;</span><br><span class="line">    @Resource(name = &quot;dbTwo&quot;)</span><br><span class="line">    DataSource dbTwo;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    SqlSessionFactory sqlSessionFactory2()throws Exception &#123;</span><br><span class="line">        SqlSessionFactoryBean bean = new SqlSessionFactoryBean();</span><br><span class="line">        bean.setDataSource(dbTwo);</span><br><span class="line">        return bean.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">    @Bean</span><br><span class="line">    SqlSessionTemplate sqlSessionTemplate2()throws Exception &#123;</span><br><span class="line">        return new SqlSessionTemplate(sqlSessionFactory2());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意连个文件的区别：<br><img src="https://img-blog.csdnimg.cn/20190921184125425.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>
<h2 id="dao-层"><a href="#dao-层" class="headerlink" title="dao 层"></a>dao 层</h2><p>在dao 层创建了两个包mapper1 和mapper2 .包里面的UserMapper类的内容是完全一样，放在不同的包中只是区分使用哪个数据源。和昨天是一样的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public interface UserMapper &#123;</span><br><span class="line"></span><br><span class="line">    @Select(&quot;select id,username as userName,password,email,role_code as roleCode,gmt_create as gmtCreate,gmt_update as gmtUpdate,nickname as nickName,user_create as userCreate from sys_user&quot;)</span><br><span class="line">    List&lt;UserEntry&gt; findUserList();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Insert(&#123;&quot;insert into sys_user(username,password,email) values(&#x27;$&#123;user.userName&#125;&#x27;,&#x27;$&#123;user.password&#125;&#x27;,&#x27;$&#123;user.email&#125;&#x27;)&quot;&#125;)</span><br><span class="line">    int add(@Param(&quot;user&quot;) UserEntry user);</span><br><span class="line"></span><br><span class="line">    @Delete(&quot;delete from sys_user where id = #&#123;id&#125;&quot;)</span><br><span class="line">    int delete(int id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="service-层"><a href="#service-层" class="headerlink" title="service 层"></a>service 层</h2><p>UserService接口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public interface UserService &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;UserEntry&gt; findUserList();</span><br><span class="line"></span><br><span class="line">    int addUser(String userName,String password,String email);</span><br><span class="line"></span><br><span class="line">    int deleteUser(int id);</span><br><span class="line"></span><br><span class="line">    List&lt;UserEntry&gt; findUserList2();</span><br><span class="line"></span><br><span class="line">    int addUser2(String userName,String password,String email);</span><br><span class="line"></span><br><span class="line">    int deleteUser2(int id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>UserServiceImpl类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">public class UserServiceImpl implements UserService &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    protected UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    protected UserMapper2 userMapper2;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;UserEntry&gt; findUserList() &#123;</span><br><span class="line">        return userMapper.findUserList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int addUser(String userName, String password, String email) &#123;</span><br><span class="line">        UserEntry user=new UserEntry();</span><br><span class="line">        user.setUserName(userName);</span><br><span class="line">        user.setPassword(password);</span><br><span class="line">        user.setEmail(email);</span><br><span class="line">        return userMapper.add(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int deleteUser(int id) &#123;</span><br><span class="line">        return userMapper.delete(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;UserEntry&gt; findUserList2() &#123;</span><br><span class="line">        return userMapper2.findUserList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int addUser2(String userName, String password, String email) &#123;</span><br><span class="line">        UserEntry user=new UserEntry();</span><br><span class="line">        user.setUserName(userName);</span><br><span class="line">        user.setPassword(password);</span><br><span class="line">        user.setEmail(email);</span><br><span class="line">        return userMapper2.add(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int deleteUser2(int id) &#123;</span><br><span class="line">        return userMapper2.delete(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="controller-层"><a href="#controller-层" class="headerlink" title="controller 层"></a>controller 层</h2><p>userController</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/user&quot;)</span><br><span class="line">public class UserController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private UserService userService;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/list&quot;,method = RequestMethod.GET)</span><br><span class="line">    public List&lt;UserEntry&gt; findUserList()&#123;</span><br><span class="line">        return userService.findUserList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/add&quot;,method = RequestMethod.GET)</span><br><span class="line">    public String addUser(@RequestParam(value = &quot;userName&quot;)String uaserName,@RequestParam(value = &quot;password&quot;)String password,@RequestParam(value = &quot;email&quot;)String email)&#123;</span><br><span class="line">        int falg=userService.addUser(uaserName,password,email);</span><br><span class="line">        if(falg&gt;0)&#123;</span><br><span class="line">            return &quot;success&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;error&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">    @RequestMapping(value = &quot;/delete&quot;,method = RequestMethod.GET)</span><br><span class="line">    public String deleteUser(@RequestParam(value = &quot;id&quot;)int id)&#123;</span><br><span class="line">        if(userService.deleteUser(id)&gt;0)&#123;</span><br><span class="line">            return &quot;success&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;error&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/list2&quot;,method = RequestMethod.GET)</span><br><span class="line">    public List&lt;UserEntry&gt; findUserList2()&#123;</span><br><span class="line">        return userService.findUserList2();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/add2&quot;,method = RequestMethod.GET)</span><br><span class="line">    public String addUser2(@RequestParam(value = &quot;userName&quot;)String uaserName,@RequestParam(value = &quot;password&quot;)String password,@RequestParam(value = &quot;email&quot;)String email)&#123;</span><br><span class="line">        int falg= userService.addUser2(uaserName,password,email);</span><br><span class="line">        if(falg&gt;0)&#123;</span><br><span class="line">            return &quot;success&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;error&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/delete2&quot;,method = RequestMethod.GET)</span><br><span class="line">    public String deleteUser2(@RequestParam(value = &quot;id&quot;)int id)&#123;</span><br><span class="line">        if(userService.deleteUser2(id)&gt;0)&#123;</span><br><span class="line">            return &quot;success&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;error&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p><img src="https://img-blog.csdnimg.cn/20190921184125702.jpeg" alt="file"><br><img src="https://img-blog.csdnimg.cn/20190921184125970.jpeg" alt="file"><br>可以看到是从不同的库中调出来的。这样就说明我们springboot配置多数据源整合mybatis 已经成功了。其实最主要就是config 包下的那三个配置类。其他的都是常见的业务逻辑，所以后面我就没有怎么讲了，代码会同步到github  上，想要实践的可以拿源码下来实践。</p>
<p>到此我们springboot整合mybatis  多数据源已经配置好了，但是我们配置下来可以发现，我们如果想要配置几个数据源就得在 dao 层创建多少个子包用来区分。那如果我们数据量足够大，要分库分表而不是几个库呢？</p>
<h1 id="分库分表"><a href="#分库分表" class="headerlink" title="分库分表"></a>分库分表</h1><h2 id="背景-1"><a href="#背景-1" class="headerlink" title="背景"></a>背景</h2><p>其实分库分表和多数据源是一样的，只不过是数据源更多了，多到在配置中配置所有的连接显得很臃肿，所以不得不另觅它法。分库分表就是 在项目中配置连接主库的连接，从主库中读取各个分库的连接，然后进行动态的加载，那个接口想调用那个分库就加载这个分库的连接。<br>我现在项目做的由于不用整合mybatis 直接使用jdbcTemplate ，所以实现起来不是很麻烦。</p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>主要就两个类；<br>GetDynamicJdbcTemplate类：手动的创建连接。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @ClassName GetDynamicJdbcTemplate</span><br><span class="line"> * @Description 获取动态的jdbcTemplate</span><br><span class="line"> * @Author zhulinfeng</span><br><span class="line"> * @Date 2019/9/20 14:35</span><br><span class="line"> * @Version 1.0</span><br><span class="line"> */</span><br><span class="line">public class GetDynamicJdbcTemplate &#123;</span><br><span class="line"></span><br><span class="line">    private  String driverClassName;</span><br><span class="line">    private  String url;</span><br><span class="line">    private  String dbUsername;</span><br><span class="line">    private  String dbPassword;</span><br><span class="line">    private JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    public JdbcTemplate getJdbcTemplate() &#123;</span><br><span class="line">        return jdbcTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public GetDynamicJdbcTemplate(String driverClassName, String url, String dbUsername, String dbPassword)&#123;</span><br><span class="line">        this.driverClassName=driverClassName;</span><br><span class="line">        this.url=url;</span><br><span class="line">        this.dbUsername=dbUsername;</span><br><span class="line">        this.dbPassword=dbPassword;</span><br><span class="line">        this.jdbcTemplate=new JdbcTemplate(getDataSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public DriverManagerDataSource getDataSource() &#123;</span><br><span class="line">        DriverManagerDataSource dataSource = new DriverManagerDataSource();</span><br><span class="line">        dataSource.setDriverClassName(driverClassName);</span><br><span class="line">        dataSource.setUrl(url);</span><br><span class="line">        dataSource.setUsername(dbUsername);</span><br><span class="line">        dataSource.setPassword(dbPassword);</span><br><span class="line">        return dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GetJdbcTemplateMap类在项目启动的时候，会读取主库中的配置，将所有分库的连接都创建好放到map中。我们是按照地市分表的，接口在调用的时候根据前端传过来的地市就可以知道使用哪个数据库连接了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">    public class GetJdbcTemplateMap implements ApplicationRunner &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    @Qualifier(&quot;baseTemplate&quot;)</span><br><span class="line">    private JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    public static Map&lt;String,JdbcTemplate&gt; JdbcTemplateMap=new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void run(ApplicationArguments args) throws Exception &#123;</span><br><span class="line">        String sql=&quot;CALL proc_baseinfo_cfg_dbsetting_query()&quot;;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; list = jdbcTemplate.queryForList(sql);</span><br><span class="line">        if(list!=null &amp;&amp; !list.isEmpty())&#123;</span><br><span class="line">            insertMap(list);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void insertMap(List&lt;Map&lt;String, Object&gt;&gt; list)&#123;</span><br><span class="line">        for(Map&lt;String, Object&gt; map :list)&#123;</span><br><span class="line">            String url=&quot;jdbc:mysql://&quot; map.get(&quot;serverip&quot;) &quot;:&quot; map.get(&quot;dbport&quot;) &quot;/&quot; map.get(&quot;dbname&quot;) &quot;?allowMultiQueries=true&amp;useUnicode=true&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&quot;;</span><br><span class="line">            log.info(url);</span><br><span class="line">            String  dbUsername=  map.get(&quot;user&quot;).toString();</span><br><span class="line">            String  dbPassword=  map.get(&quot;password&quot;).toString();</span><br><span class="line">            GetDynamicJdbcTemplate getDynamicJdbcTemplate=new GetDynamicJdbcTemplate(ConstantClass.DRIVERCLASSNAME,url,dbUsername,dbPassword);</span><br><span class="line">            JdbcTemplate jdbcTemplate=getDynamicJdbcTemplate.getJdbcTemplate();</span><br><span class="line">            JdbcTemplateMap.put(map.get(&quot;cityid&quot;).toString(),jdbcTemplate);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190921184126325.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>
<p>在接口中调用也很方便。<br><img src="https://img-blog.csdnimg.cn/20190921184126584.jpeg" alt="file"></p>
<p>但是上面讲的只适合我们自己特有的业务，并且也没有整合mybatis ,所以我就没有写在我自己的项目中，这里提供出来是给大家一个思路。</p>
<h1 id="番外"><a href="#番外" class="headerlink" title="番外"></a>番外</h1><p>也算是写完了这篇，感觉写的不是很好，但是有不知道怎么修改，暂时就先这样吧，后续有思路了再进行修改。又问问我为什么不先整合Thymeleaf  弄出页面来。之所以没有弄，是因为我想后期做前后端分离都是以接口的形式调用。所以想先将后端的部分都搭建好，再来整合前端的。<br>好了，就说这么多啦，今天项目的代码也同步到github 上啦。<br>github地址：<a target="_blank" rel="noopener" href="https://github.com/QuellanAn/zlflovemm">https://github.com/QuellanAn/zlflovemm</a></p>
<p>后续加油♡</p>
<p>欢迎大家关注个人公众号 “程序员爱酸奶”</p>
<p>分享各种学习资料，包含java，linux，大数据等。资料包含视频文档以及源码，同时分享本人及投递的优质技术博文。</p>
<p>如果大家喜欢记得关注和分享哟❤<br><img src="https://img-blog.csdnimg.cn/2019092118412737.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/09/19/%E4%BA%8C%E3%80%81springBoot%20%E6%95%B4%E5%90%88%20mybatis%20%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/09/19/%E4%BA%8C%E3%80%81springBoot%20%E6%95%B4%E5%90%88%20mybatis%20%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" class="post-title-link" itemprop="url">二、springBoot 整合 mybatis 项目实战</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-09-19 22:11:53" itemprop="dateCreated datePublished" datetime="2019-09-19T22:11:53+08:00">2019-09-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-02-25 15:14:51" itemprop="dateModified" datetime="2022-02-25T15:14:51+08:00">2022-02-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/springBoot/" itemprop="url" rel="index"><span itemprop="name">springBoot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇文章开始了我们的springboot序篇，我们配置了mysql数据库，但是我们sql语句直接写在controller中并且使用的是jdbcTemplate。项目中肯定不会这样使用，上篇文章也说了，会结合mybatis 或者JPA 使用。我们这篇文章就来结合 mybatis 来使用吧，至于为什么选mybatis 而不是JPA ，这个看个人洗好吧。然后这篇文章会附带一讲一下今天为项目新增的配置。主要是为了保持项目和文章的一致性。</p>
<p>先贴出我们今天项目的结构吧，和昨天贴出来的差不多，在那基础上添加了一些东西，整个框架的模型算是成型了。<br><img src="https://img-blog.csdnimg.cn/20190919221150687.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>
<h1 id="引入mybatis依赖"><a href="#引入mybatis依赖" class="headerlink" title="引入mybatis依赖"></a>引入mybatis依赖</h1><p>一般改动都是从pom.xml 开始的，我们在昨天基础上的pom.xml  文件中加上mybatis 依赖,版本自己选吧。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.0.0&lt;/version&gt;</span><br><span class="line"> &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h1 id="Entry层"><a href="#Entry层" class="headerlink" title="Entry层"></a>Entry层</h1><p>昨天我们创建了一个user表 并插入了一条数据，我们就先用这张表吧，所以我们在entry 包中创建一个UserEntry 的实体类.<br>代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">@Getter</span><br><span class="line">@Setter</span><br><span class="line">public class UserEntry &#123;</span><br><span class="line">    private int id;</span><br><span class="line">    private String userName;</span><br><span class="line">    private String password;</span><br><span class="line">    private String email;</span><br><span class="line">    private String roleCode;</span><br><span class="line">    private String roleName;</span><br><span class="line">    private String gmtCreate;</span><br><span class="line">    private String gmtUpdate;</span><br><span class="line">    private String nickname;</span><br><span class="line">    private String userCreate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里用的注解和@Getter 和@Setter。这里就是避免代码中写入过多的get和 set 方法，使得代码变得更加简洁。</p>
<h1 id="Dao-层"><a href="#Dao-层" class="headerlink" title="Dao 层"></a>Dao 层</h1><p>Dao是用来处理数据的，这里我们引入了mybatis ,可以使用注解，也可以创建xml 文件，将sql 语句写在xml 文件中。我们这里就采用注解的方式吧，毕竟我们springboot项目，不想再出现xml配置文件了(后期也说不定哈哈)。</p>
<p>在dao包下创建一个userMapper 接口。代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Mapper</span><br><span class="line">public interface UserMapper &#123;</span><br><span class="line"></span><br><span class="line">    @Select(&quot;select id,username as userName,password,email,role_code as roleCode,gmt_create as gmtCreate,gmt_update as gmtUpdate,nickname as nickName,user_create as userCreate from sys_user&quot;)</span><br><span class="line">    List&lt;UserEntry&gt; findUserList();</span><br><span class="line"></span><br><span class="line">    @Insert(&#123;&quot;insert into sys_user(username,password,email) values(&#x27;$&#123;user.userName&#125;&#x27;,&#x27;$&#123;user.password&#125;&#x27;,&#x27;$&#123;user.email&#125;&#x27;)&quot;&#125;)</span><br><span class="line">    int add(@Param(&quot;user&quot;) UserEntry user);</span><br><span class="line"></span><br><span class="line">    @Delete(&quot;delete from sys_user where id = #&#123;id&#125;&quot;)</span><br><span class="line">    int delete(int id);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们这里就先写一个查询、删除和插入的方法吧。可以看到，在接口上引入@Mapper  注解，然后就可以直接使用@Select 和@Insert 等注解啦，直接把注解sql 语句写在这里面就可以了。</p>
<h1 id="Service-层"><a href="#Service-层" class="headerlink" title="Service 层"></a>Service 层</h1><p>service层我们一般都以一个接口和一个实现接口的具体类。</p>
<h2 id="service-接口"><a href="#service-接口" class="headerlink" title="service 接口"></a>service 接口</h2><p>代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public interface UserService &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;UserEntry&gt; findUserList();</span><br><span class="line"></span><br><span class="line">    int addUser(String userName,String password,String email);</span><br><span class="line"></span><br><span class="line">    int deleteUser(int id);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="serviceImpl-具体实现类。"><a href="#serviceImpl-具体实现类。" class="headerlink" title="serviceImpl 具体实现类。"></a>serviceImpl 具体实现类。</h2><p>在service 包的impl 包创建 UserServiceImpl 类。代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class UserServiceImpl implements UserService &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    protected UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;UserEntry&gt; findUserList() &#123;</span><br><span class="line">        return userMapper.findUserList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int addUser(String userName, String password, String email) &#123;</span><br><span class="line">        UserEntry user=new UserEntry();</span><br><span class="line">        user.setUserName(userName);</span><br><span class="line">        user.setPassword(password);</span><br><span class="line">        user.setEmail(email);</span><br><span class="line">        return userMapper.add(user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public int deleteUser(int id) &#123;</span><br><span class="line">        return userMapper.delete(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="controller-层"><a href="#controller-层" class="headerlink" title="controller 层"></a>controller 层</h1><p>我们在controller 包下的userinfo  包下创建UserController 类。代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/user&quot;)</span><br><span class="line">public class UserController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private UserService userService;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/list&quot;,method = RequestMethod.GET)</span><br><span class="line">    public List&lt;UserEntry&gt; findUserList()&#123;</span><br><span class="line">        return userService.findUserList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/add&quot;,method = RequestMethod.GET)</span><br><span class="line">    public String addUser(@RequestParam(value = &quot;userName&quot;)String uaserName,@RequestParam(value = &quot;password&quot;)String password,@RequestParam(value = &quot;email&quot;)String email)&#123;</span><br><span class="line">        int falg=userService.addUser(uaserName,password,email);</span><br><span class="line">        if(falg&gt;0)&#123;</span><br><span class="line">            return &quot;success&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;error&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value = &quot;/delete&quot;,method = RequestMethod.GET)</span><br><span class="line">    public String deleteUser(@RequestParam(value = &quot;id&quot;)int id)&#123;</span><br><span class="line">        if(userService.deleteUser(id)&gt;0)&#123;</span><br><span class="line">            return &quot;success&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;error&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><p>好了，万事具备，来测试吧。我们启动项目后，在浏览器输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">添加一个用户</span><br><span class="line">http://localhost:9090/zlflovemm/user/add?userName=qaz&amp;password=123456&amp;email=123@qq.com</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190919221150962.jpeg" alt="file"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查询所有用户</span><br><span class="line">http://localhost:9090/zlflovemm/user/list</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190919221151243.jpeg" alt="file"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">删除一个用户</span><br><span class="line">http://localhost:9090/zlflovemm/user/delete?id=19</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190919221151558.jpeg" alt="file"></p>
<p>都没有问题啦，说明基本的增删改查整合 mybatis 都是可行的。</p>
<h1 id="配置多环境文件"><a href="#配置多环境文件" class="headerlink" title="配置多环境文件"></a>配置多环境文件</h1><p>好了，大头讲完了，我们现在来讲讲项目今天进行了哪些配置。首先我们来看下我们项目中多了好几个配置文件。<br><img src="https://img-blog.csdnimg.cn/20190919221151978.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"><br>分别对应的是开发环境，测试环境，生产环境。毕竟我们在实际开发过程中，这三个环境都是经常有用到的，总会有数据库连接改来改去的问题。这里直接配置多份，想用哪个用那个就可以了。避免反复改容易出错的问题。<br>我这里就暂时把连接mysql 的链接放到不同环境了。<br>先在application.properties中加入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spring.profiles.active=dev</span><br><span class="line">表示用的是开发环境，就会读取application-dev.yml 文件中的配置。</span><br></pre></td></tr></table></figure>
<p>application-dev.xml文件内容如下，另外两个文件也差不多，就不贴出来了。<br><img src="https://img-blog.csdnimg.cn/20190919221152316.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>
<h1 id="配置日志"><a href="#配置日志" class="headerlink" title="配置日志"></a>配置日志</h1><p>项目中怎么能缺乏日志文件呢，我这里用的springboot 自带的日志框架logback 也很方便。我们先在application.properties 中加入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#日志配置</span><br><span class="line">logging.level.org.springframework.web=info</span><br><span class="line">logging.config=classpath:logback.xml</span><br><span class="line">debug=true</span><br></pre></td></tr></table></figure>
<p>然后在 application.properties  同目录下创建一个 logback.xml.内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;configuration debug=&quot;false&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--定义日志文件的存储地址 勿在 LogBack 的配置中使用相对路径--&gt;</span><br><span class="line">    &lt;property name=&quot;LOG_HOME&quot; value=&quot;./logs&quot; /&gt;</span><br><span class="line">    &lt;property name=&quot;INFO_FILE&quot; value=&quot;zlflovemm_log&quot; /&gt;</span><br><span class="line">    &lt;property name=&quot;ERROR_FILE&quot; value=&quot;zlflovemm_error&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--控制台日志， 控制台输出 --&gt;</span><br><span class="line">    &lt;appender name=&quot;STDOUT&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;</span><br><span class="line">        &lt;encoder class=&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt;</span><br><span class="line">            &lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度,%msg：日志消息，%n是换行符--&gt;</span><br><span class="line">            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n&lt;/pattern&gt;</span><br><span class="line">        &lt;/encoder&gt;</span><br><span class="line">    &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 文件保存日志的相关配置，同步 --&gt;</span><br><span class="line">    &lt;appender name=&quot;FILE&quot;  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">        &lt;Prudent&gt;true&lt;/Prudent&gt;</span><br><span class="line">        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">            &lt;!--日志文件输出的文件名--&gt;</span><br><span class="line">            &lt;FileNamePattern&gt;</span><br><span class="line">                $&#123;LOG_HOME&#125;/$&#123;INFO_FILE&#125;-%d&#123;yyyy-MM-dd&#125;.log</span><br><span class="line">            &lt;/FileNamePattern&gt;</span><br><span class="line">            &lt;!--日志文件保留天数--&gt;</span><br><span class="line">            &lt;MaxHistory&gt;30&lt;/MaxHistory&gt;</span><br><span class="line">        &lt;/rollingPolicy&gt;</span><br><span class="line">        &lt;encoder class=&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt;</span><br><span class="line">            &lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span><br><span class="line">            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;[%t][%thread] %-5level %logger&#123;36&#125; - %msg%n&lt;/pattern&gt;</span><br><span class="line">        &lt;/encoder&gt;</span><br><span class="line">        &lt;!--日志文件最大的大小--&gt;</span><br><span class="line">        &lt;triggeringPolicy class=&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;&gt;</span><br><span class="line">            &lt;MaxFileSize&gt;10MB&lt;/MaxFileSize&gt;</span><br><span class="line">        &lt;/triggeringPolicy&gt;</span><br><span class="line">    &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 文件保存日志的相关配置，同步 --&gt;</span><br><span class="line">    &lt;appender name=&quot;ERROR&quot;  class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;</span><br><span class="line">        &lt;filter class=&quot;ch.qos.logback.classic.filter.ThresholdFilter&quot;&gt;</span><br><span class="line">            &lt;level&gt;ERROR&lt;/level&gt;</span><br><span class="line">        &lt;/filter&gt;</span><br><span class="line">        &lt;Prudent&gt;true&lt;/Prudent&gt;</span><br><span class="line">        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;</span><br><span class="line">            &lt;!--日志文件输出的文件名--&gt;</span><br><span class="line">            &lt;FileNamePattern&gt;</span><br><span class="line">                $&#123;LOG_HOME&#125;/$&#123;ERROR_FILE&#125;-%d&#123;yyyy-MM-dd&#125;.log</span><br><span class="line">            &lt;/FileNamePattern&gt;</span><br><span class="line">            &lt;!--日志文件保留天数--&gt;</span><br><span class="line">            &lt;MaxHistory&gt;30&lt;/MaxHistory&gt;</span><br><span class="line">        &lt;/rollingPolicy&gt;</span><br><span class="line">        &lt;encoder class=&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;&gt;</span><br><span class="line">            &lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span><br><span class="line">            &lt;pattern&gt;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;[%t][%thread] %-5level %logger&#123;36&#125; - %msg%n&lt;/pattern&gt;</span><br><span class="line">        &lt;/encoder&gt;</span><br><span class="line">        &lt;!--日志文件最大的大小--&gt;</span><br><span class="line">        &lt;triggeringPolicy class=&quot;ch.qos.logback.core.rolling.SizeBasedTriggeringPolicy&quot;&gt;</span><br><span class="line">            &lt;MaxFileSize&gt;10MB&lt;/MaxFileSize&gt;</span><br><span class="line">        &lt;/triggeringPolicy&gt;</span><br><span class="line">    &lt;/appender&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- 日志输出级别 --&gt;</span><br><span class="line">    &lt;root level=&quot;INFO&quot;&gt;</span><br><span class="line">        &lt;appender-ref ref=&quot;STDOUT&quot; /&gt;</span><br><span class="line">        &lt;appender-ref ref=&quot;FILE&quot;/&gt;</span><br><span class="line">        &lt;appender-ref ref=&quot;ERROR&quot; level=&quot;error&quot; /&gt;</span><br><span class="line">    &lt;/root&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure>

<p>这样项目日志就配置好了，至于日志的具体配置，修改logback.xml 里面参数就可以了。和log4g差不多。</p>
<h1 id="配置banner"><a href="#配置banner" class="headerlink" title="配置banner"></a>配置banner</h1><p>最后既然是一个项目，当然得有点标志性的东西，比如logo。springboot 给我们留下了一个彩蛋就是banner。我们可以在项目启动的时候，显示我们独一无二的logo .<br>在application.properties 同目录下创建 banner.txt<br><img src="https://img-blog.csdnimg.cn/20190919221152597.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"><br>艺术字大家在网上自行搜索，这里就不推荐啦哈哈。这样我们在项目启动的时候就会加载我们的logo. 算是给广大的我们一点福利吧。</p>
<h1 id="番外"><a href="#番外" class="headerlink" title="番外"></a>番外</h1><p>今晚总算是写完了，本来会早点的，但是不知道怎么就弄这么晚了。<br>今天项目的代码也同步到github 上啦。<br>github地址：<a target="_blank" rel="noopener" href="https://github.com/QuellanAn/zlflovemm">https://github.com/QuellanAn/zlflovemm</a></p>
<p>后续加油♡</p>
<p>欢迎大家关注个人公众号 “程序员爱酸奶”</p>
<p>分享各种学习资料，包含java，linux，大数据等。资料包含视频文档以及源码，同时分享本人及投递的优质技术博文。</p>
<p>如果大家喜欢记得关注和分享哟❤<br><img src="https://img-blog.csdnimg.cn/2019091922115335.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/09/18/%E4%B8%80%E3%80%81springboot%E8%B5%B7%E8%88%AA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/09/18/%E4%B8%80%E3%80%81springboot%E8%B5%B7%E8%88%AA/" class="post-title-link" itemprop="url">一、springboot起航</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-09-18 15:42:33" itemprop="dateCreated datePublished" datetime="2019-09-18T15:42:33+08:00">2019-09-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-02-25 15:14:51" itemprop="dateModified" datetime="2022-02-25T15:14:51+08:00">2022-02-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/springBoot/" itemprop="url" rel="index"><span itemprop="name">springBoot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前零零散散的学习了一些springboot的知识，以及搭建一些springboot的项目，甚至还有一些项目应用到实际项目中了，但是突然有一天想要建一个自己的项目网站。发现自己不知道从何开始。发现自己虽然用了很久，但是让自己 从头开始搭建一个却处处碰壁。所以静下心来好好的整理一下springboot的知识点。以及给自己搭建一个springboot 项目的脚手架。以后方便自己套用。</p>
<h1 id="创建spring-boot项目"><a href="#创建spring-boot项目" class="headerlink" title="创建spring boot项目"></a>创建spring boot项目</h1><p>springboot的之所以火热便是因为开箱即用的特效，低配置甚至无配置使用，方便我们快速上手，我们这里先就什么都不配置吧。<br>在idea 上直接可以创建springboot 类型项目。<br><img src="https://img-blog.csdnimg.cn/20190918101453978.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>项目名就随便起吧，整个系列就都以这个项目为例啦，整个项目会分享到github 上，大家需要的可以跟着下载学习。<br>建好的项目目录如下：<br><img src="https://img-blog.csdnimg.cn/20190918102640866.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>其中选中的文件夹是我自己加的，因为我想整个项目的目录大概就是这个样子了。文件名起了zlflovemm 没有什么项目含义，起名太难了，就起了一个自己纪念的名字，大家勿怪。<br>我们pom.xml 内容，因为后期不管是加其他组件，还是引用 jar 包什么的都是改这里。所以把最初版本拿出来。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.1.8.RELEASE&lt;/version&gt;</span><br><span class="line">        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    &lt;groupId&gt;com.quellan&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;zlflovemm&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0.0&lt;/version&gt;</span><br><span class="line">    &lt;name&gt;zlflovemm&lt;/name&gt;</span><br><span class="line">    &lt;description&gt;zlflovemm project for Spring Boot&lt;/description&gt;</span><br><span class="line"></span><br><span class="line">    &lt;properties&gt;</span><br><span class="line">        &lt;java.version&gt;1.8&lt;/java.version&gt;</span><br><span class="line">    &lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line"></span><br><span class="line">    &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">            &lt;/plugin&gt;</span><br><span class="line">        &lt;/plugins&gt;</span><br><span class="line">    &lt;/build&gt;</span><br><span class="line"></span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到pom.xml 文件里面东西很少了，parent 中是 springboot 版本信息。properties 是 jdk 版本信息。dependencies中的依赖只有一个starter-web 和starter-test 前面是这个项目支持web 项目，后面一个是支持单元测试，这两个都是创建项目的时候自带的。build 中就是项目构建打包的方式啦。这里暂时先用这种方式。</p>
<h1 id="hello-world"><a href="#hello-world" class="headerlink" title="hello world"></a>hello world</h1><p>我们还是来写一个hello world 吧，虽然有点幼稚，但毕竟遵循一下古训。<br>我们在controller  包下创建一个demo 包。在demo 包下创建一个 demo.java .</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class Demo &#123;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/&quot;)</span><br><span class="line">    public String demo()&#123;</span><br><span class="line">        return &quot;hello world&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20190918134050165.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>在controller 层用到的注解最多的就是@RestController 和@RequestMapping 了。@RestController和@Controller 注解是使用在controller层的。和@RequestMapping注解是用于设置映射路径的。这里注解就不深入讲解了，后面会进行深入的讲解。<br>我们代码写完之后，我们来启动项目看一下，这里我们就直接运行 ZlflovemmApplication中的 main 方法就好了。然后在浏览器输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:8080</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190918135316609.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>到此原型已经搭建好了，可以发现我们什么都没有配置，都是使用的默认的配置，直接写的测试代码，然后就可以直接使用。</p>
<p>但是这样对于一个项目来说远远不够的，我们来为项目增加一些配置。</p>
<h1 id="配置mysql"><a href="#配置mysql" class="headerlink" title="配置mysql"></a>配置mysql</h1><p>其实一开始就配置mysql 太唐突了，但是一些小配置，不想再起一节，所以就一起了。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>首先当然是创建数据库和表啦，这里idea 也可以连接mysql 数据库，我们就一切都在idea上操作吧。<br><img src="https://img-blog.csdnimg.cn/20190918141251265.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>配置我们数据库连接，我这里已经在我的虚拟机上搭建好了mysql,说到搭建MySQL 也遇到一些坑。没有整理成单独的博客，大家可以参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/opsprobe/p/9126864.html">Ubuntu18.04下安装MySQL</a><br><img src="https://img-blog.csdnimg.cn/20190918142127501.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>连接好之后，我们执行一下sql ,创建数据库，创建表，插入数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE /*!32312 IF NOT EXISTS*/`zlflovemm` /*!40100 DEFAULT CHARACTER SET utf8 */;</span><br><span class="line">USE `zlflovemm`;</span><br><span class="line">CREATE TABLE `sys_user` (</span><br><span class="line">  `id` INT(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `username` VARCHAR(255) NOT NULL,</span><br><span class="line">  `password` VARCHAR(255) NOT NULL,</span><br><span class="line">  `email` VARCHAR(255) NOT NULL,</span><br><span class="line">  `role_code` VARCHAR(255) NOT NULL,</span><br><span class="line">  `role_name` VARCHAR(255) NOT NULL,</span><br><span class="line">  `gmt_create` DATETIME NOT NULL,</span><br><span class="line">  `gmt_update` DATETIME NOT NULL,</span><br><span class="line">  `nickname` VARCHAR(255) DEFAULT NULL,</span><br><span class="line">  `user_create` INT(11) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=INNODB AUTO_INCREMENT=17 DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">/*Data for the table `sys_user` */</span><br><span class="line"></span><br><span class="line">INSERT  INTO `sys_user`(`id`,`username`,`password`,`email`,`role_code`,`role_name`,`gmt_create`,`gmt_update`,`nickname`,`user_create`) VALUES (1,&#x27;admin&#x27;,&#x27;123456&#x27;,&#x27;345849402@qq.com&#x27;,&#x27;admin&#x27;,&#x27;管理员&#x27;,&#x27;2019-03-21 14:30:57&#x27;,&#x27;2019-03-21 14:30:57&#x27;,&#x27;admin&#x27;,1);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们测试一下我们数据库建成功没有。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from sys_user</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/2019091814493198.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>这样说明我们数据库是没有问题的。</p>
<h2 id="pom-xml-中添加依赖"><a href="#pom-xml-中添加依赖" class="headerlink" title="pom.xml 中添加依赖"></a>pom.xml 中添加依赖</h2><p>我们现在pom.xml 中添加依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>前面两个是mysql 依赖，lombok 是方便我们getter方法和setter方法以及引入日志的。后面代码中会体现。</p>
<h1 id="配置application-properties"><a href="#配置application-properties" class="headerlink" title="配置application.properties"></a>配置application.properties</h1><p>在application.properties中配置如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server.port=9090</span><br><span class="line">server.servlet.context-path=/zlflovemm</span><br><span class="line">server.tomcat.uri-encoding=UTF-8</span><br><span class="line">spring.http.encoding.charset=UTF-8</span><br><span class="line">spring.http.encoding.enabled=true</span><br><span class="line">spring.http.encoding.force=true</span><br><span class="line">spring.messages.encoding=UTF-8</span><br><span class="line"></span><br><span class="line">spring.datasource.driver-class-name=com.mysql.jdbc.Driver</span><br><span class="line">spring.datasource.url=jdbc:mysql://192.168.252.53:3306/zlfdb?characterEncoding=utf-8&amp;useSSL=false&amp;zeroDateTimeBehavior=CONVERT_TO_NULL</span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=123456</span><br><span class="line">spring.datasource.max-idle=10</span><br><span class="line">spring.datasource.max-wait=10000</span><br><span class="line">spring.datasource.min-idle=5</span><br><span class="line">spring.datasource.initial-size=5</span><br></pre></td></tr></table></figure>

<p>前面配置访问端口为9090，访问路径为&#x2F;zllovemm&#x2F;，设置编码格式为utf-8.下面就是配置mysql 。</p>
<h1 id="编写测试"><a href="#编写测试" class="headerlink" title="编写测试"></a>编写测试</h1><p>为了方便，我们就直接在controller编写测试。<br>在controller包中建一个包 userinfo ,在userinfo中创建一个UserController并编写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class UserController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/getUser&quot;)</span><br><span class="line">    public List&lt;Map&lt;String, Object&gt;&gt; getUser()&#123;</span><br><span class="line">        String sql=&quot;select * from sys_user&quot;;</span><br><span class="line">        return jdbcTemplate.queryForList(sql);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190918153845847.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>然后我们来启动项目，在浏览器中输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:9090/zlflovemm/getUser</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/201909181536262.png" alt="在这里插入图片描述"><br>可以看到数据库是配置成功的。当然正式的项目肯定不能这样写，正式的项目会采用mybatis 或者JPA ,这个后期项目肯定也是会用的，所以这里就暂时这样写。</p>
<h1 id="番外"><a href="#番外" class="headerlink" title="番外"></a>番外</h1><p>项目的雏形就先这样吧，后续加入其它组件，会继续在这个项目上跟新。<br>github地址：<a target="_blank" rel="noopener" href="https://github.com/QuellanAn/zlflovemm">https://github.com/QuellanAn/zlflovemm</a></p>
<p>这篇就到这里吧，也算是开篇了</p>
<p>后续加油♡</p>
<p>欢迎大家关注个人公众号 “程序员爱酸奶”</p>
<p>分享各种学习资料，包含java，linux，大数据等。资料包含视频文档以及源码，同时分享本人及投递的优质技术博文。</p>
<p>如果大家喜欢记得关注和分享哟❤<br><img src="https://img-blog.csdnimg.cn/2019091922115335.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/09/10/%E4%B8%80%E3%80%81%E8%AE%A9%E6%88%91%E4%BB%AC%E5%BC%80%E5%90%AF%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E4%B9%8B%E6%97%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/09/10/%E4%B8%80%E3%80%81%E8%AE%A9%E6%88%91%E4%BB%AC%E5%BC%80%E5%90%AF%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E4%B9%8B%E6%97%85/" class="post-title-link" itemprop="url">一、让我们开启单元测试之旅</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-09-10 19:43:45" itemprop="dateCreated datePublished" datetime="2019-09-10T19:43:45+08:00">2019-09-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-02-25 15:14:51" itemprop="dateModified" datetime="2022-02-25T15:14:51+08:00">2022-02-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/" itemprop="url" rel="index"><span itemprop="name">单元测试</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>思量良久在考虑要不要写这一篇，是不是直接看门见山将在项目中怎么进行单元测试。最后想想觉得是不是太猴急了写那样，就好比你想和一个姑娘滚床单，是不是先应该请姑娘吃顿饭、送点礼物什么的。所以我才决定写这篇序言，让我们一起慢慢的揭开单元测试的面纱。</p>
<h1 id="什么是单元测试"><a href="#什么是单元测试" class="headerlink" title="什么是单元测试"></a>什么是单元测试</h1><p>这个在网上有很详细的解释。我这就简单的给出一个概念：<br><strong>单元测试是开发者编写一小段代码，用于检测被测代码的一个很小的、很明确的功能是否正确。</strong></p>
<p>单元测试是对软件基本单元进行的测试，实际应用中是对public 函数进行的测试。<br>执行单元测试，是为了验证某段代码的行为确实和开发者所期望的一致。</p>
<h1 id="为什么要进行单元测试"><a href="#为什么要进行单元测试" class="headerlink" title="为什么要进行单元测试"></a>为什么要进行单元测试</h1><p>理由千千万，我只宠这三点：</p>
<ul>
<li>减少调试时间</li>
<li>自动化测试</li>
<li>令设计变得更好</li>
</ul>
<p>我们或多或少也都听说过单元测试，只知道用来检测写的代码有没有问题，这导致之前都没有写过测试用例，测试一些重要的方法最多也一个 main方法正常的数据调通了就过了，这样导致后期出现各种各样的问题，一遍遍的改代码，一遍遍的改bug。费时费力还不一定能处理好。我以为这是软件开发的诟病，其实不然，是因为我们不能确认我们写的那部分代码没有问题，所以总花费很长时间找问题上。所以才需要进行单元测试，虽然在刚开始写单元测试会花费时间，但是我们单元测试全都通过之后，我们对自己写的代码更有自信，可以确定没有代码没有问题了，而不是自己认为没有问题的那种。这样后期修复bug,也可以通过单元测试哪些执行成功哪些执行失败可以快速的定位到问题。我觉得这一点就足以让我们为我们写的代码编写相应的单元测试啦，毕竟找问题真是太痛苦，大家应该也深有体会。</p>
<h1 id="单元测试怎么做"><a href="#单元测试怎么做" class="headerlink" title="单元测试怎么做"></a>单元测试怎么做</h1><p>简单而言，就是对一个 public 方法编写测试用例，那测试用例又怎么写呢？<br>测试用例说白了也是一个方法，用来验证目标方法是否符合我们的预期。<br>那这样就知道怎么写了吧，就是和我们平时写方法一样，但是它有一个标准<br>俗称 “3A 模式” Arrange-Act-Assert（准备上下文环境–执行被测函数–断言）。也就是说一个测试用例的方法包含三部分就可以了。</p>
<h1 id="测试用例应该具备的特征"><a href="#测试用例应该具备的特征" class="headerlink" title="测试用例应该具备的特征"></a>测试用例应该具备的特征</h1><p>上面说的测试用例包含这三部分就可以了，那我们的测试用例应该具备怎样的特征呢，<strong>短小精悍且快准繁</strong></p>
<blockquote>
<p>小：一个测试几行代码（15）<br>精准：一个测试之测一个场景<br>隔离：每个测试都可以独立、重复运行，无耦合<br>快：每个测试都应该是毫秒级别的<br>频繁：应该频繁的执行，没增加、修改、删除一个测试都要运行一遍</p>
</blockquote>
<p>那什么样的是好的单元测试呢？<br>自动化<br>可重复的<br>彻底的<br>独立的<br>专业的</p>
<h1 id="好的测试用例"><a href="#好的测试用例" class="headerlink" title="好的测试用例"></a>好的测试用例</h1><p>测试用例应该短小精悍且快准狠。这些是对测试用例的函数本身而言的，但在实际项目中出问题往往就是某些情况没有考虑到导致程序出错的，我们在自测的时候往往会测试正常数据的情况然而却忽略的了错误情况和边界值的测试，这些才是校验一个项目的健壮性的标准。所以好的测试用例必定是有全面的测试数据。那怎样获取全面的测试数据呢？<br>在这之前需要知道哪些是好的测试数据</p>
<ul>
<li>最优可能抓住错误的</li>
<li>不是重复的，多余的</li>
<li>一组相似测试用例中最有效的</li>
<li>既不是太简单，也不是太复杂</li>
</ul>
<p>那怎样获取好的测试数据呢？有等价类划分法、边界值法、路径分析法。</p>
<h2 id="等价类划分法"><a href="#等价类划分法" class="headerlink" title="等价类划分法"></a>等价类划分法</h2><p>等价类划分法是把所有可能的输入数据，划分成若干个子集，然后从每个子集中选取少数的具有代表性的数据作为测试用例。<br>该方法是一种重要的、常用的黑盒测试用例设计方法。</p>
<p>有效等价类：对程序的规范说明是合理的，有意义的输入数据构成的集合。<br>无效等价类：对程序的规范说明不是合理的或者无意义的输入数据构成的集合。</p>
<p>我们来看一个例子：计算两个点距离的函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public double getDistance(double x1, double y1, double x2, double y2)</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190910202707791.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="边界值法"><a href="#边界值法" class="headerlink" title="边界值法"></a>边界值法</h2><p>边界值分析法是对输入或者输出的边界值进行测试的一组黑盒测试方法。</p>
<p>通常情况下，边界值分析法是作为等价类划分法的补充，这种情况下，其测试用例来自等价类的边界。</p>
<p>比如上面一个例子中取边界值做为测试用例。</p>
<h2 id="路径分析法"><a href="#路径分析法" class="headerlink" title="路径分析法"></a>路径分析法</h2><p>基本路径测试是一种白盒测试方法，它在程序控制图的基础上，通过分析程序的流程，构造导出基本可执行路径集合，从而设计测试用例的方法。</p>
<p>设计出的测试用例要保证在测试程序中的每一个可执行语句至少执行一次。<br>我们来看一个例子<br><img src="https://img-blog.csdnimg.cn/20190910203310419.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>可能的路径为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1-2-3-4-5</span><br><span class="line">1-2-3-4-6</span><br><span class="line">1-2-4-5</span><br><span class="line">1-2-4-6</span><br></pre></td></tr></table></figure>

<h1 id="断言"><a href="#断言" class="headerlink" title="断言"></a>断言</h1><p>我们这里说的断言只是Junit断言，java 本身也有断言的，但是貌似我们使用的很少以至于我们都忘记了它的存在。<br>Junit 断言说是断言，其实也就是一份方法，没有什么语法。我们测试用例中使用断言，也就是使用这些方法来进行验证是否达到我们的预期。<br>方法有很多，大家可以看看源码，我这里给出几个常见的。</p>
<table>
<thead>
<tr>
<th>函数名</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>assertEquals</td>
<td>判断实际产生的值与期望值是否相等</td>
</tr>
<tr>
<td>assertNull</td>
<td>判断对象是否为null</td>
</tr>
<tr>
<td>assertNotNull</td>
<td>判断对象是否为非null</td>
</tr>
<tr>
<td>assertSame</td>
<td>判断实际产生的对象与期望对象是否为同一个对象</td>
</tr>
<tr>
<td>assertNotSame</td>
<td>判断实际产生的对象与期望对象是否为不同的对象</td>
</tr>
<tr>
<td>assertTrue</td>
<td>判断bool变量是否为真</td>
</tr>
<tr>
<td>assertFalse</td>
<td>判断bool变量是否为假</td>
</tr>
<tr>
<td>Fail</td>
<td>使测试立即失败</td>
</tr>
</tbody></table>
<p>上面这样说好像没有什么效果，我们先来看其中一个断言方法的源代码。我们就看第一个assertEquals 吧<br><img src="https://img-blog.csdnimg.cn/20190911091719454.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>可以看到有很多assertEquals方法。这样的方法的重载在底层很常见。我们来看下三个参数类似是Object的这个吧。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">public static void assertEquals(String message, Object expected, Object actual) &#123;</span><br><span class="line">        if (!equalsRegardingNull(expected, actual)) &#123;</span><br><span class="line">            if (expected instanceof String &amp;&amp; actual instanceof String) &#123;</span><br><span class="line">                String cleanMessage = message == null ? &quot;&quot; : message;</span><br><span class="line">                throw new ComparisonFailure(cleanMessage, (String)expected, (String)actual);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                failNotEquals(message, expected, actual);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">private static boolean equalsRegardingNull(Object expected, Object actual) &#123;</span><br><span class="line">        if (expected == null) &#123;</span><br><span class="line">            return actual == null;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return isEquals(expected, actual);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static boolean isEquals(Object expected, Object actual) &#123;</span><br><span class="line">        return expected.equals(actual);</span><br><span class="line">    &#125;</span><br><span class="line">private static void failNotEquals(String message, Object expected, Object actual) &#123;</span><br><span class="line">        fail(format(message, expected, actual));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static String format(String message, Object expected, Object actual) &#123;</span><br><span class="line">        String formatted = &quot;&quot;;</span><br><span class="line">        if (message != null &amp;&amp; !message.equals(&quot;&quot;)) &#123;</span><br><span class="line">            formatted = message + &quot; &quot;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String expectedString = String.valueOf(expected);</span><br><span class="line">        String actualString = String.valueOf(actual);</span><br><span class="line">        return expectedString.equals(actualString) ? formatted + &quot;expected: &quot; + formatClassAndValue(expected, expectedString) + &quot; but was: &quot; + formatClassAndValue(actual, actualString) : formatted + &quot;expected:&lt;&quot; + expectedString + &quot;&gt; but was:&lt;&quot; + actualString + &quot;&gt;&quot;;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>equalsRegardingNull() 函数就是判断两个值是否相等，底层还是相当于用的object.equals()。如果两个值相等就断言通过，如果不相等就判断expected和actual是否是string类型，如果是直接将message输出。如果不是就failNotEquals().failNotEquals方法的源码我也贴出来了，可以看也很简单，就是message、expected、actual转换成string格式输出出来，并执行fail()使得测试失败。</p>
<p>从上面看断言也就不过如此(Junit 断言)。我们会使用常用的方法就可以写好测试用例啦，至于其他的方法，我们用到的时候可以直接其源代码，毕竟也不会很复杂。</p>
<h1 id="简单案例"><a href="#简单案例" class="headerlink" title="简单案例"></a>简单案例</h1><h2 id="目标代码及功能说明"><a href="#目标代码及功能说明" class="headerlink" title="目标代码及功能说明"></a>目标代码及功能说明</h2><p><img src="https://img-blog.csdnimg.cn/20190911110536460.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>这段代码在项目中的作用是对特殊字段的对应的值进行处理并返回。<br>如果字段是包含time，那将值改成日期格式返回。<br>如果字段是包含iphone,那将值截取后11位返回。<br>其他情况，直接返回。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">public class DataHandle &#123;</span><br><span class="line">    public static final String REGEX_MOBILE = &quot;^((13[0-9])|(15[0-9])|(17[0-9])|(18[0-9])|(19[0-9])|(14[0-9]))\\d&#123;8&#125;$&quot;;</span><br><span class="line"></span><br><span class="line">    public String fieldDataHandle(String key,String value)&#123;</span><br><span class="line">        //如果是时间类型，将时间戳转成时间</span><br><span class="line">         if(key.toLowerCase().contains(&quot;ipone&quot;))&#123;  //如果手机号长于11位，截取后11位</span><br><span class="line">            if(value.length()&gt;11)&#123;</span><br><span class="line">                value=value.substring(value.length()-11);</span><br><span class="line">            &#125;</span><br><span class="line">            if(!isMobile(value))&#123;</span><br><span class="line">                return null;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else if(key.toLowerCase().contains(&quot;time&quot;))&#123;</span><br><span class="line">            value=timeStampToDate(value,&quot;yyyy-MM-dd HH:mm:ss&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return value;</span><br><span class="line">    &#125;</span><br><span class="line">    private static String timeStampToDate(String time,String timeFormat) &#123;</span><br><span class="line">        Long timeLong = Long.parseLong(time);</span><br><span class="line">        SimpleDateFormat sdf = new SimpleDateFormat(timeFormat);//要转换的时间格式</span><br><span class="line">        Date date;</span><br><span class="line">        try &#123;</span><br><span class="line">            date = sdf.parse(sdf.format(timeLong));</span><br><span class="line">            return sdf.format(date);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static boolean isMobile(String mobile) &#123;</span><br><span class="line">        return Pattern.matches(REGEX_MOBILE, mobile);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="单元测试设计"><a href="#单元测试设计" class="headerlink" title="单元测试设计"></a>单元测试设计</h2><p>等价类设计</p>
<table>
<thead>
<tr>
<th>等价类划分</th>
<th>有效等价类</th>
<th>无效等价类</th>
</tr>
</thead>
<tbody><tr>
<td>key</td>
<td>包含time, 包含ipone,包含time和ipone</td>
<td>不包含time 和ipone</td>
</tr>
<tr>
<td>value</td>
<td>时间戳，手机号，带区号的手机号</td>
<td>不是时间戳，也不是手机号</td>
</tr>
<tr>
<td>我们根据这个来设计测试用例</td>
<td></td>
<td></td>
</tr>
<tr>
<td>key</td>
<td>value</td>
<td>预期值</td>
</tr>
<tr>
<td>–</td>
<td>–</td>
<td>–</td>
</tr>
<tr>
<td>字段包含time</td>
<td>时间戳</td>
<td>返回日期格式的的字符串</td>
</tr>
<tr>
<td>字段包含time</td>
<td>不是时间戳</td>
<td>null</td>
</tr>
<tr>
<td>字段包含ipone</td>
<td>不是手机号</td>
<td>null</td>
</tr>
<tr>
<td>字段包含ipone</td>
<td>是11位的手机号</td>
<td>返回11位手机号字符串</td>
</tr>
<tr>
<td>字段包含ipone</td>
<td>是手机号，但位数大于11位</td>
<td>返回11位手机号字符串</td>
</tr>
<tr>
<td>字段包含time,ipone</td>
<td>时间戳</td>
<td>返回日期格式的的字符串</td>
</tr>
<tr>
<td>字段包含time,ipone</td>
<td>不是手机号，也不是时间戳</td>
<td>null</td>
</tr>
<tr>
<td>字段包含time,ipone</td>
<td>手机号</td>
<td>null</td>
</tr>
<tr>
<td>字段不包含time 和ipone</td>
<td>时间戳</td>
<td>时间戳字符串</td>
</tr>
<tr>
<td>字段不包含time 和ipone</td>
<td>11位手机号</td>
<td>手机号字符串</td>
</tr>
<tr>
<td>字段不包含time 和ipone</td>
<td>大于11位手机号</td>
<td>返回值字符串</td>
</tr>
<tr>
<td>字段不包含time 和ipone</td>
<td>不是手机号，也不是时间戳</td>
<td>值对应字符串</td>
</tr>
</tbody></table>
<p>编写测试用例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">public class DataHandleTest &#123;</span><br><span class="line"></span><br><span class="line">    DataHandle dataHandle = null;</span><br><span class="line"></span><br><span class="line">    @Before</span><br><span class="line">    public void setup()</span><br><span class="line">    &#123;</span><br><span class="line">        dataHandle = new DataHandle();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @After</span><br><span class="line">    public void tearDown()</span><br><span class="line">    &#123;</span><br><span class="line">        dataHandle = null;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testFieldDataHandle_包含time是时间戳_返回日期字符串()&#123;</span><br><span class="line">        assertEquals(&quot;2019-09-10 19:02:30&quot;, dataHandle.fieldDataHandle(&quot;atime&quot;,&quot;1568113350000&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testFieldDataHandle_包含time不是时间戳_返回NULL()&#123;</span><br><span class="line">        assertNull(dataHandle.fieldDataHandle(&quot;atime&quot;,&quot;1568113350aaa&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testFieldDataHandle_包含ipone不是手机号_返回NULL()&#123;</span><br><span class="line">        assertNull(dataHandle.fieldDataHandle(&quot;bipone&quot;,&quot;aaa&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testFieldDataHandle_包含ipone是11位手机号_返回手机号字符串()&#123;</span><br><span class="line">        assertEquals(&quot;13265459362&quot;,dataHandle.fieldDataHandle(&quot;bipone&quot;,&quot;13265459362&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testFieldDataHandle_包含ipone是大于11位手机号_返回手机号字符串()&#123;</span><br><span class="line">        assertEquals(&quot;13265459362&quot;,dataHandle.fieldDataHandle(&quot;bipone&quot;,&quot;+8613265459362&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testFieldDataHandle_包含time和ipone是时间戳_返回NULL()&#123;</span><br><span class="line">        assertNull(dataHandle.fieldDataHandle(&quot;atimebipone&quot;,&quot;1568168656000&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testFieldDataHandle_包含time和ipone是手机号_返回手机号字符串()&#123;</span><br><span class="line">        assertEquals(&quot;13265459362&quot;,dataHandle.fieldDataHandle(&quot;atimebipone&quot;,&quot;13265459362&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testFieldDataHandle_包含time和ipone不是时间戳手机号_返回NULL()&#123;</span><br><span class="line">        assertNull(dataHandle.fieldDataHandle(&quot;atimebipone&quot;,&quot;aaabbb&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testFieldDataHandle_不包含time和ipone是时间戳_返回时间戳字符串()&#123;</span><br><span class="line">        assertEquals(&quot;1568114439&quot;,dataHandle.fieldDataHandle(&quot;ccc&quot;,&quot;1568114439&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testFieldDataHandle_不包含time和ipone是11位手机号_返回时间手机号字符串()&#123;</span><br><span class="line">        assertEquals(&quot;13112341234&quot;,dataHandle.fieldDataHandle(&quot;ccc&quot;,&quot;13112341234&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testFieldDataHandle_不包含time和ipone是大于11位手机号_返回值字符串()&#123;</span><br><span class="line">        assertEquals(&quot;+8613412341234&quot;,dataHandle.fieldDataHandle(&quot;ccc&quot;,&quot;+8613412341234&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void testFieldDataHandle_不包含time和ipone不是时间戳手机号_返回值字符串()&#123;</span><br><span class="line">        assertEquals(&quot;abcdefg&quot;,dataHandle.fieldDataHandle(&quot;ccc&quot;,&quot;abcdefg&quot;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>然后我们执行一下测试用例；<br><img src="https://img-blog.csdnimg.cn/20190911110726313.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>可以看到有一个地方的测试用例是不通过的，那就说明有问题，我们看一下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">   public void testFieldDataHandle_包含time不是时间戳_返回NULL()&#123;</span><br><span class="line">       assertNull(dataHandle.fieldDataHandle(&quot;atime&quot;,&quot;1568113350aaa&quot;));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这个是抛异常了，因为日期格式转换错误，但是我们在日期转换的时候已经捕获了呀，并且返回为null 。<br><img src="https://img-blog.csdnimg.cn/20190911110830274.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>那为什么测试用例没有通过呢，而是直接抛异常出来了，调试发现这个方法没有捕获到异常，而是直接抛出给Junit了。所以这里提示代码不能这么写。一般异常了不建议返回null.而是打印出异常把信息抛出。这里我们就不改了。我们将测试用例改一下，在测试用例中捕获一下异常。<br>改成如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@Test(expected = NumberFormatException.class)</span><br><span class="line">   public void testFieldDataHandle_包含time不是时间戳_throwsException()&#123;</span><br><span class="line">       dataHandle.fieldDataHandle(&quot;atime&quot;,&quot;1568113350aaa&quot;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>再全部执行一下<br><img src="https://img-blog.csdnimg.cn/20190911112006427.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>这样就不抱错了。<br>好啦这个就是一个简单的测试用例啦。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>最后总结一下吧，我觉得应该知道以下几点</p>
<ul>
<li>认识到单元测试的必要性</li>
<li>好的测试用例是关键</li>
<li>测试用例中断言必不可少</li>
<li>编写测试用例的规范要遵循</li>
</ul>
<p>看到这啦的小伙伴，如果觉得喜欢就点个赞吧嘿嘿。如果有什么意见，欢迎给我提。嘿嘿。后续想写一下测试用例的规范，喜欢的可以持续关注❤</p>
<p>欢迎大家关注个人公众号 “程序员爱酸奶”</p>
<p>分享各种学习资料，包含java，linux，大数据等。资料包含视频文档以及源码，同时分享本人及投递的优质技术博文。</p>
<p>如果大家喜欢记得关注和分享哟❤<br><img src="https://img-blog.csdnimg.cn/2019091922115335.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/09/05/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8Fngrok_ngrokcc_cpolar/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/09/05/%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8Fngrok_ngrokcc_cpolar/" class="post-title-link" itemprop="url">内网穿透ngrok_ngrokcc_cpolar</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-09-05 18:46:02" itemprop="dateCreated datePublished" datetime="2019-09-05T18:46:02+08:00">2019-09-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-02-25 15:14:51" itemprop="dateModified" datetime="2022-02-25T15:14:51+08:00">2022-02-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%BB%BA%E7%AB%99%E4%B9%8B%E8%B7%AF/" itemprop="url" rel="index"><span itemprop="name">建站之路</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>先来说说问题吧，我们的项目在测试环境上搭建好了，也就是在内网上可以正常运行，但是呢，局方的人想要看一下效果先，那问题就来了，不在同一个局域网，他们访问不了我们的内网啊，现在又想看。这咋整。所以就有了这篇文章。<br>这三个软件都差不多，都有一个免费的，我自己都试了一下，window和Linux的都可以，做演示的话问题不大。刚刚好满足要求。</p>
<h1 id="官网"><a href="#官网" class="headerlink" title="官网"></a>官网</h1><p>ngrok:<a target="_blank" rel="noopener" href="https://ngrok.com/">https://ngrok.com/</a><br>ngrokc:<a target="_blank" rel="noopener" href="http://www.ngrok.cc/">http://www.ngrok.cc/</a><br>cpolar:<a target="_blank" rel="noopener" href="https://www.cpolar.com/">https://www.cpolar.com/</a></p>
<p>大家对着官网教程来就可以了，无非都是注册会员，领取那个免费的authtoken.然后下载客户端，设置端口，启动项目，用域名进行访问。</p>
<h1 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h1><p>1、ngrok 和 cpolar 基本用法都是一致的，都是生成一个authtoken ,然后设置一个ip和端口，会随机的生成一个http的域名和一个https 的域名随机访问。<br><img src="https://img-blog.csdnimg.cn/20190905185742950.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>2、ngrokcc 是国内的一个网站，没有authtoken ,但是有隧道，需要你在控制台建好隧道，然后在客户端连接隧道id 就好了<br><img src="https://img-blog.csdnimg.cn/20190905190106504.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./sunny clientid 隧道id</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190905190543757.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>使用起来还是比较简单，能满足我们将项目搭建在本地，用公网访问演示。</p>
<h1 id="番外"><a href="#番外" class="headerlink" title="番外"></a>番外</h1><p>这几个是三个软件都是利用Nginx反向代理实现的。但是免费的只有一个隧道或者一个端口，这个时候我们可以在自己本地再搭建一个Nginx做虚拟主机，这样就可以自由飞翔了吧哈哈</p>
<h1 id="再番外"><a href="#再番外" class="headerlink" title="再番外"></a>再番外</h1><p>因为看了一下官方文档，发现不仅可以代理一个端口网站，还能代理tcp协议。</p>
<p>我来举一个例子。我有两台电脑，一台装的是win ,一台装的是Ubuntu，一般我都是把Ubuntu当做服务器用。两台电脑在同一个局域网直接用xhell 的ssh 连接起来当然很方便啦。但是我有时候需要把win 带到其他地方，那做服务器的那台电脑就不能访问啦，<br>所以我参考一下官网的，可以在用外网访问这台服务器啦。<br>操作也很简单，我三个也都测试了一下，用的是cpolar 的，感觉比ngrok 要稳定些。<br>1、在我们Ubuntu服务器上安装好cpolar客户端，然后认证tocken 这些和之前是一样哒。<br>2、</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpolar tcp 22</span><br></pre></td></tr></table></figure>
<p>就这么简单。<br><img src="https://img-blog.csdnimg.cn/20190906141633105.png" alt="在这里插入图片描述"></p>
<p>然后在主机和端口号填上对应的就好了，就是这么简单。<br><img src="https://img-blog.csdnimg.cn/20190906141742822.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>这样之后，就算两台电脑不在同一个局域网，也可以直接访问了，很实用。</p>
<p>后续加油♡</p>
<p>欢迎大家关注个人公众号 “程序员爱酸奶”</p>
<p>分享各种学习资料，包含java，linux，大数据等。资料包含视频文档以及源码，同时分享本人及投递的优质技术博文。</p>
<p>如果大家喜欢记得关注和分享哟❤<br><img src="https://img-blog.csdnimg.cn/2019091922115335.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/09/03/%E5%85%AB%E3%80%81redis%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/09/03/%E5%85%AB%E3%80%81redis%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">八、redis集群</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-09-03 20:21:09" itemprop="dateCreated datePublished" datetime="2019-09-03T20:21:09+08:00">2019-09-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-02-25 15:14:51" itemprop="dateModified" datetime="2022-02-25T15:14:51+08:00">2022-02-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前面写完了 Redis 的主从复制、哨兵模式、Redis 持久化方式。这篇文章开始写 Redis 集群啦。</p>
<p>我们项目中使用 Redis 一般都不是使用单台 Redis 提供服务，除非是很小的项目，不过很小的项目也没有必要使用Redis了。所以一般使用 Redis 都会配上 Redis主从备（就是前面将的主从复制），配上哨兵模式实现故障转移。更大的项目就搭建一个 Redis 集群。</p>
<p>但是呢，我们大多数在项目中即使使用了 Redis ，都是直接使用的，框架什么的都已经被前面的人搭建好了。所以我们在使用的时候其实就是配置的时候有些不同，代码中使用起来和单机的 Redis 是没有什么区别的。所以并不能说我们对 Redis 集群有多了解。</p>
<p>所以接下来，就让我们来了解一下 Redis 集群吧，手把手搭建一个 Redis 集群 ，让我们对 Redis 集群有更多的了解 。</p>
<h1 id="什么是-Redis-集群"><a href="#什么是-Redis-集群" class="headerlink" title="什么是 Redis 集群"></a>什么是 Redis 集群</h1><p>进入正文啦，既然学习 Redis 集群，那什么是 Redis 集群呢？</p>
<p><strong>Redis 集群是 Redis 提供的分布式数据库方案，集群通过分片( sharding )来实现数据共享，并提供复制和故障转移。</strong></p>
<p>可以说上面这句话是对 redis 集群的高度概括了，redis 集群提供分布式数据库方案，前面我们将的主从复制和哨兵模式可以知道，只会有一个主服务器( master )。主从复制，只会有一个 master ，可以有多个 slave。而哨兵模式是在主从复制的基础上，发现 master 挂掉，会自动的将其中一个 salve 升级成 master 。但是最终结果还是只有一个 master。所以如果系统很大，对Redis 写操作的压力就会很大，所以才出现的集群的模式。集群模式可以有多个 master 。来看下面集群模式的图(下面的图不是最终版，便于理解的。后文有最终版的)：<br><img src="https://img-blog.csdnimg.cn/20190828163053884.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>手动画的可能有点丑，但是大概的意思就是这样啦。单个节点就是我们之前了解的主从复制的一主多从(图中是一主两从)，加上哨兵模式，来监听节点的 master 是否正常。 那集群就是多个节点组成的，多个节点的 master 数据共享，横向分担单个节点 master 的压力。那从上图可以看出 哨兵模式 其实是 集群模式的一个子集，集群模式是哨兵模式的一个拓展。</p>
<h1 id="Redis-集群有什么好处，用在哪些场景"><a href="#Redis-集群有什么好处，用在哪些场景" class="headerlink" title="Redis 集群有什么好处，用在哪些场景"></a>Redis 集群有什么好处，用在哪些场景</h1><p>上面讲了什么是 Reids 集群，那为什么要使用 Redis 集群呢，不直接使用哨兵模式呢？使用 Redis 集群有什么好处呢？</p>
<p>要回答上面这个问题，其实在上一节已经差不多介绍了，集群模式是哨兵模式的一种拓展，既然是拓展，当时是因为哨兵模式不能满足需求才会产生的。</p>
<p>在没有Redis 集群的时候，人们使用哨兵模式，所有的数据都存在 master 上面，master 的压力越来越大，垂直扩容再多的 salve 已经不能分担 master 的压力的，因为所有的写操作集中都集中在 master 上。所以人们就想到了水平扩容，就是搭建多个 master 节点。客户端进行分片，手动的控制访问其中某个节点。但是这几个节点之间的数据是不共享的。 并且如果增加一个节点，需要手动的将数据进行迁移，维护起来很麻烦。所以才产生了 Redis 集群。</p>
<p>所以 Redis 集群有什么好处，就是进一步提升 Redis 性能，分布式部署实现高可用性，更加的稳定。当然还包含主从复制的数据热备份以及哨兵模式的故障转移等有点啦。</p>
<p>那 Redis 集群用在哪些场景呢？</p>
<p>其实我感觉一般较大的项目使用了 redis 的话，都会使用 redis 集群。毕竟在部署的时候先做好充分的拓展准备，比到时候项目出现瓶颈再去拓展成本就要小太多了。并且 Redis 是轻量级的，采用 redis 集群，也许在项目初期根本就用不上多个节点，单个节点就够用，多节点造成浪费。但是其实我们启动多个节点没有用到的话，节点所占用的内存和CPU 是非常小的。所以建议一般项目使用 Redis的话，尽量使用 Redis 集群吧。</p>
<h1 id="集群的主从复制和故障转移"><a href="#集群的主从复制和故障转移" class="headerlink" title="集群的主从复制和故障转移"></a>集群的主从复制和故障转移</h1><p>Redis 集群的主从复制，其实和单机的主从复制是一样的。前面 Redis 集群结构图可以看到。单个节点中有一个 master 和多个 slave 。这些 slave 会自动的同步 master中的数据。注意的是，这些 salve 只会同步 所属的 master 中的数据，集群中其他的 master 数据是不会同步的。</p>
<p>同样的 ，当个节点中可以配置多个哨兵，来监控这个节点中的master 是否下线了，如果下线了就会将这个节点的slave 选择一个升级成 master 并继承之前 master 的分片，继续工作。</p>
<p>但是其实啊，在集群模式中，并没有配置哨兵，我们也能实现故障的自动转移。其实真正的集群的图是这样的：<br><img src="https://img-blog.csdnimg.cn/20190828175641528.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>如图可以看到并没有为每个节点配置 sentinel 。那怎么实现对 master 的监听，实现故障的自动转移呢？</p>
<p>我们在讲哨兵模式的时候说过，其实哨兵也是一种特殊的 redis 服务对吧。我们master 是通过 <code> redis-server</code> 启动的。我们哨兵是通过 <code> redis-sentinel</code>启动的。然后哨兵的作用就是定期的给 master 发送 <code>ping </code>检测 master 是否下线，然后通过选举的方式选择 slave 升级成 master<br>那放在集群中可以发现，哨兵的这些工作，完全可以交给master 来做。之前单个节点，master 做不了才交给 sentinel 的。现在有多个 master ，当然就可以用 master 来代替salve 的工作啦<br>在集群中，每个节点的master 定期的向其他节点 master 发送 <code>ping </code>命令，如果没有收到<code>pong</code> 响应，则会认为主观下线，并将这个消息发送给其他的 master。其他的 master 在接收到这个消息后就保存起来。当某个节点的 master 收到 半数以上的消息认为这个节点主观下线后，就会判定这个节点客观下线。并将这个节点客观下线的消息通知给其他的master。<br>这个客观节点下线后，其他的  master 节点 就会选举 下线的master中的 slave 一个变成 新的master 继续工作。从而实现故障自动转移。这个选举过程和哨兵模式中是一样的，只不过是 master 代替了 sentinel 的工作。</p>
<h1 id="搭建一个-Redis-集群的实例"><a href="#搭建一个-Redis-集群的实例" class="headerlink" title="搭建一个 Redis 集群的实例"></a>搭建一个 Redis 集群的实例</h1><p>好接下来让我们一起来搭建一个集群模式吧，因为我只有一台服务器，所以我集群就搭建在一台服务器上，在实际项目中肯定是多台服务器搭建集群的。但是搭建的方式都是一样的。这里我将两种集群的搭建方式，第一种是手动的搭建集群，手动分片，这种方便我们对集群有更多的了解，第二种的话借助 Redis 自带的辅助工具来搭建集群，方便快捷。</p>
<h2 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h2><p>好了，让我们开始吧，在开始之前，我们不用觉得搭建集群很麻烦，其实一样的是修改redis.conf配置文件中的内容。只需要将配置文件中集群模式打开就可以了。如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster-enabled yes</span><br></pre></td></tr></table></figure>
<p>是不是很简单，还是不说废话的，搞起来。</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>先创建一个 cluster 目录，然后在 cluster 目录下创建6个文件夹。因为的演示中我的cluster 目录已经占用了，我就再创建是cluster2 目录。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cd  /usr/local/redis/etc</span><br><span class="line">mkdir cluster2</span><br><span class="line">cd  cluster2</span><br><span class="line">mkdir 8000</span><br><span class="line">mkdir 8001</span><br><span class="line">mkdir 8002</span><br><span class="line">mkdir 8003</span><br><span class="line">mkdir 8004</span><br><span class="line">mkdir 8005</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190829142130721.png" alt="在这里插入图片描述"><br>然后将redis.conf文件copy到这六个文件中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cp ~/workSpace/redis-4.0.9/redis.conf ./8000/redis.conf</span><br><span class="line">cp ~/workSpace/redis-4.0.9/redis.conf ./8001/redis.conf</span><br><span class="line">cp ~/workSpace/redis-4.0.9/redis.conf ./8002/redis.conf</span><br><span class="line">cp ~/workSpace/redis-4.0.9/redis.conf ./8003/redis.conf</span><br><span class="line">cp ~/workSpace/redis-4.0.9/redis.conf ./8004/redis.conf</span><br><span class="line">cp ~/workSpace/redis-4.0.9/redis.conf ./8005/redis.conf</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190829142604241.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>准备工作做好了，现在我们来修改这六个目录下的配置文件吧。都将开启集群模式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ./8000/redis.conf</span><br></pre></td></tr></table></figure>
<p>修改配置文件如下，我们为了方便就先不进行太复杂的配置，我们就配置搭建集群最小力度修改。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">port 8000</span><br><span class="line">daemonize yes</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190829143706226.png" alt="在这里插入图片描述"><br>上面修改的是8000这个目录下的redis.conf ，接下来我们按部就班的把其他几个文件中的配置也进行修改。和上面的基本一样。这里就不一一写出来了。贴一个8002的修改，大家就一目了然了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">port 8002</span><br><span class="line">daemonize yes</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>修改好这几个配置文件后，然后就启动这些服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/redis/etc/cluster2/8000/</span><br><span class="line">redis-server ./redis.conf </span><br><span class="line"></span><br><span class="line">cd /usr/local/redis/etc/cluster2/8001/</span><br><span class="line">redis-server ./redis.conf </span><br><span class="line"></span><br><span class="line">cd /usr/local/redis/etc/cluster2/8002/</span><br><span class="line">redis-server ./redis.conf </span><br><span class="line"></span><br><span class="line">cd /usr/local/redis/etc/cluster2/8003/</span><br><span class="line">redis-server ./redis.conf </span><br><span class="line"></span><br><span class="line">cd /usr/local/redis/etc/cluster2/8004/</span><br><span class="line">redis-server ./redis.conf </span><br><span class="line"></span><br><span class="line">cd /usr/local/redis/etc/cluster2/8005/</span><br><span class="line">redis-server ./redis.conf </span><br></pre></td></tr></table></figure>

<p>如下图：<br><img src="https://img-blog.csdnimg.cn/20190829202739916.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>上图可以看到，会先进入到对应的文件夹，然后启动redis服务，为什么要先进入对应的文件夹呢？因为我们配置了<code>cluster-config-file nodes.conf</code> 这个会在你启动目录下生成一个node.conf 文件，用来存放当前节点信息。所以你不先进入对应目录的话，很很可能就启动不成功哟。下图可以看到生成了 node.conf 以及里面的内容。<br><img src="https://img-blog.csdnimg.cn/20190829203246860.png" alt="在这里插入图片描述"><br>我们在来通过线程的方式查看一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef |grep redis</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190829203446966.png" alt="在这里插入图片描述"><br>可以发现我们启动的6个节点都已经启动了，并且后面都带有 cluster 的标识。和 6379 单机模式有区别。</p>
<h3 id="节点互通"><a href="#节点互通" class="headerlink" title="节点互通"></a>节点互通</h3><p>到此准备工作算是真正的做完了，我们启动了六个节点，但是现在这六个节点是相互独立的，没有任何关联，那我们怎么将它们关联起来呢？<br>我们先用客户端进入到8000节点。查看一下节点信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 8000</span><br><span class="line">cluster nodes</span><br></pre></td></tr></table></figure>
<p>可以看到只有自身这个节点的信息。现在我们和其他节点建立连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cluster meet  ip  port</span><br></pre></td></tr></table></figure>
<p>下图可以看我们和8001节点建立连接，这个时候再查看nodes节点信息，发现就有两个节点信息啦，说明这个集群中现在存在了8000 和8001 两个节点。<br><img src="https://img-blog.csdnimg.cn/20190830150256224.png" alt="在这里插入图片描述"><br>我们现在把8002 节点也加进来。这样原本的各自独立的节点就在同一个集群中啦，大概就是下面这张图（有点丑，将就看）<br><img src="https://img-blog.csdnimg.cn/20190902113443323.gif" alt="在这里插入图片描述"></p>
<h3 id="槽指派"><a href="#槽指派" class="headerlink" title="槽指派"></a>槽指派</h3><p>上面已经进行了节点互通了，多个节点在同一个集群中了，那我们是不是就可以使用集群了呢？<br>其实不行，我们来看一下<code>cluster info</code><img src="https://img-blog.csdnimg.cn/20190902131512152.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>发现 cluster_status 还是fail。表明还是不可用的。因为我们还没有进行卡槽的分派。<br>Redis 集群是通过分片的方式来保存数据库中的键值对的，集群整个数据库被分成16384个槽（slot）。也就是说所有数据的key都会映射到对应的 slot 中。只有当数据库中16384 个槽都在节点上有分派，集群才会上线，否则集群的状态就是 fail。<br>所以接下来开始槽指派吧</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cluster addslots  slots[slots]</span><br><span class="line">样例：</span><br><span class="line">cluster addslots 0 1 2 </span><br><span class="line">cluster addslots 0 1 2 ... 5000</span><br><span class="line">cluster addslots &#123;0..5000&#125;</span><br></pre></td></tr></table></figure>
<p>网上说的可以支持范围分配的，但是我电脑上试了 N 种方法都不行，我的 redis 版本是4.0.9 的。最后没办法，写了一个脚本跑的。<br><img src="https://img-blog.csdnimg.cn/20190902180531659.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>如果大家也不行的话，可以用脚本跑吧。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">start=$1</span><br><span class="line">end=$2</span><br><span class="line">port=$3</span><br><span class="line">for slot in `seq $&#123;start&#125; $&#123;end&#125;`</span><br><span class="line">do</span><br><span class="line">           echo &quot;slot:$&#123;slot&#125;&quot;</span><br><span class="line">              redis-cli -p $&#123;port&#125; cluster addslots $&#123;slot&#125;</span><br><span class="line">      done</span><br><span class="line">~              </span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190902181223836.png" alt="在这里插入图片描述"><br>然后执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sh add-slots.sh 0 5000 8000</span><br><span class="line">sh add-slots.sh 5001 10000 8001</span><br><span class="line">sh add-slots.sh 10000 16384 8002</span><br></pre></td></tr></table></figure>
<p>这样就可以把16384个卡槽分配到三个节点上啦，如果有多个节点，自己调整分配哈，我这里是以三个节点为例的。</p>
<p>卡槽分配完成以后，我们在来看看 cluster  的状态<br><img src="https://img-blog.csdnimg.cn/20190902181442458.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>发现 cluster_status 变成 ok 了。说明我们的卡槽分配是成功的。</p>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>那现在集群上线了，是不是就可以用了呢?<br>答案是是的，但是配到现在为止还有点瑕疵，瑕疵我们待会再说，先来看看集群能不能操作命令。<br><img src="https://img-blog.csdnimg.cn/20190903083508917.png" alt="在这里插入图片描述"><br>可以看到，进行槽指派之后是可以进行正常的操作的，这里的<code>set a 123</code>提示我移动到8002端口执行。因为a 对应的卡槽为15495.<br>这里有一个命令和可以查看key值在哪一个卡槽，从而属于哪一个节点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:8000&gt; CLUSTER KEYSLOT a</span><br><span class="line">(integer) 15495</span><br><span class="line">127.0.0.1:8000&gt; </span><br></pre></td></tr></table></figure>
<p>那假如我就想set a 呢，难道要先切换到8002端口，那岂不是很麻烦，还有另一种方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -c -p 8000</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190903084627953.png" alt="在这里插入图片描述"><br>可以看到这样启动客户端，会自动的将数据存入到对应的节点上，并切换到这个节点，并且之前我在8000 端口上<code>set data 123</code>,我现在在8002端口上<code>get data </code> 会自动的找到key值并切换到8000端口上，这样在客户端就感觉这三个节点是一个整体啦，是不是很方便。</p>
<h3 id="配置主从"><a href="#配置主从" class="headerlink" title="配置主从"></a>配置主从</h3><p>前面为止，集群模式已经搭建好了，但是呢前文说的还有点瑕疵，现在就来说说，我们现在搭建的集群只有三个主节点，任何一个主节点挂掉了，就会导致集群不可用，因为集群可用的标志是 16384 个卡槽全部都分配到可用的节点上。所以我们现在搭建的集群还是不稳定的。所以为了解决这个问题，我们需要为每一个主节点配置一个从节点。<br>从节点的作用是数据热备份和当主节点出现故障时可以替代主节点进行工作。</p>
<p>好了，我们来搭建主从吧，前文中我们创建了6个节点，还有三个没用，其实就是用来搭建主从的哈哈。还没有用到的这三个节点 和搭建好的这个集群是独立的现在。<br>第一步，将这三个节点加入到集群中来。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cluster meet  127.0.0.1 8003</span><br><span class="line">cluster meet  127.0.0.1 8004</span><br><span class="line">cluster meet  127.0.0.1 8005</span><br></pre></td></tr></table></figure>
<p>第二步，查找主节点的 nodesId。通过 <code>cluster nodes </code>可以查到到集群中所有节点的信息，第一列就是每个节点的nodesId.<br><img src="https://img-blog.csdnimg.cn/20190903091254964.png" alt="在这里插入图片描述"><br>第三步，将从节点和主节点关联起来。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 8003 cluster replicate 9a86d899be55a37d3ac1c8be6c342c7f59513076</span><br><span class="line">redis-cli -p 8004 cluster replicate 03efbb8782a705d5978f5c1b14d4dcba14a167e8</span><br><span class="line">redis-cli -p 8005 cluster replicate 01f6c1888b7a103c10fffe9cf6be8a5fff8ae985</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190903092754288.png" alt="在这里插入图片描述"><br>我们再来看看节点信息<br><img src="https://img-blog.csdnimg.cn/20190903093105713.png" alt="在这里插入图片描述"><br>可以看到从节点已经搭建成功啦，那到底有没有成功呢，我们再来试试，我们手动模拟主节点8000故障了。我们用<code>shutdown</code>可以关闭当前节点的服务。<br><img src="https://img-blog.csdnimg.cn/20190903093408249.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>看一下进程确定8000已经关闭了<br><img src="https://img-blog.csdnimg.cn/20190903093544690.png" alt="在这里插入图片描述"><br>我们现在进入8001端口看一下，<code>get data</code>可以看到切换到8003端口上了，8003端口是8000端口的从节点，现在8000端口挂掉了，8003端口会代替8000端口继续工作。<br><img src="https://img-blog.csdnimg.cn/20190903100959947.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>我们看一下<code>cluster nodes </code> 发现8000端口节点是 fail 的，8003端口升级成master了。我们现在修复了8000端口问题，将其重启起来看看。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">quellanan@quellanan-Lenovo-G400:/usr/local/redis/etc/cluster2/8000$ redis-server ./redis.conf </span><br><span class="line">26401:C 03 Sep 10:13:31.777 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br><span class="line">26401:C 03 Sep 10:13:31.777 # Redis version=4.0.9, bits=64, commit=00000000, modified=0, pid=26401, just started</span><br><span class="line">26401:C 03 Sep 10:13:31.777 # Configuration loaded</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然后看看节点信息，发现8003端口变成了主节点，8000端口变成了8003端口的从节点。这和我们之前哨兵模式是一样的。<br><img src="https://img-blog.csdnimg.cn/20190903101643703.png" alt="在这里插入图片描述"><br>好啦，到此为止，一个集群算是真正的搭建好啦。一步一步的来，不难，就几个命令而已，可能我写得比较啰嗦嘿嘿。</p>
<h2 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h2><h3 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h3><p>第二种方法搭建集群就简单讲啦，准备工作和启动都是一样的，只是不用我们自己进行节点互通和分配卡槽啦。如下图，我已经启动 7000~7005 六个节点。<br><img src="https://img-blog.csdnimg.cn/20190903103718865.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install ruby</span><br><span class="line">yum install rubygems</span><br><span class="line">gem install redis </span><br></pre></td></tr></table></figure>
<p>我这里已经安装好了，就不演示啦。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>执行以下命令，就会自动的帮我们进行节点互通，分配卡槽以及设置从节点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./redis-trib.rb create --replicas 1 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>特别提醒，这里的IP用主机的IP，如果使用127.0.0.1的话，在我们代码中访问会出错，我也是在项目中使用的时候碰到的</strong><br><img src="https://img-blog.csdnimg.cn/20190903112941564.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>上面就已经搭建好集群啦，简单吧。</p>
<h3 id="验证-1"><a href="#验证-1" class="headerlink" title="验证"></a>验证</h3><p>我们现在简单验证一下，进入7000节点；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -c -p 7000</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/2019090311331399.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>可以看到集群是上线状态，可以正常使用啦，我们简单操作一波<br><img src="https://img-blog.csdnimg.cn/20190903113444307.png" alt="在这里插入图片描述"><br>好啦，集群搭建的实例就说这么多吧，两种方式，第一种是原生的，第二种是借助工具的，效果是一样的。还有一个内容就是重新分片。这个用到的不多，我们前期在搭建集群的时候先预留多个节点就好，不然后面要扩容，就需要用到重新分片，感兴趣的可以在讨论区讨论下吧，也不难，这里就不写了(文章太长啦)。</p>
<h1 id="在项目中使用集群"><a href="#在项目中使用集群" class="headerlink" title="在项目中使用集群"></a>在项目中使用集群</h1><p>在项目中使用集群，我这里就简单的给一个样例给大家参考。</p>
<h2 id="创建一个springboot-项目"><a href="#创建一个springboot-项目" class="headerlink" title="创建一个springboot 项目"></a>创建一个springboot 项目</h2><p><img src="https://img-blog.csdnimg.cn/20190903171721569.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>基本上一直next 就好了。</p>
<h2 id="修改pom-xml文件"><a href="#修改pom-xml文件" class="headerlink" title="修改pom.xml文件"></a>修改pom.xml文件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;!--Redis使用starter--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">      </span><br><span class="line">        &lt;!--注解日志/get/set--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;net.sf.json-lib&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;json-lib&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.4&lt;/version&gt;</span><br><span class="line">            &lt;classifier&gt;jdk15&lt;/classifier&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">    &lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<h2 id="修改application-yml"><a href="#修改application-yml" class="headerlink" title="修改application.yml"></a>修改application.yml</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 9090</span><br><span class="line"></span><br><span class="line"># redis 集群配置</span><br><span class="line">spring:</span><br><span class="line">  redis:</span><br><span class="line">    cluster:</span><br><span class="line">      nodes: 192.168.252.53:7000,192.168.252.53:7001,192.168.252.53:7002,192.168.252.53:7003,192.168.252.53:7004,192.168.252.53:7005</span><br><span class="line">      timeout: 6000ms # 连接池超时时间（毫秒）</span><br><span class="line">    # 密码没有可以不填</span><br><span class="line">    password:</span><br><span class="line">    database: 0 # 数据库索引</span><br><span class="line">    lettuce:</span><br><span class="line">      pool:</span><br><span class="line">        max-active: 8 # 连接池最大活跃连接数（使用负值表示没有限制）</span><br><span class="line">        max-idle: 8 # 连接池最大空闲连接数</span><br><span class="line">        max-wait: -1ms # 连接池最大阻塞等待时间 毫秒（使用负值表示没有限制）</span><br><span class="line">        min-idle: 0  #最小空闲连接数</span><br></pre></td></tr></table></figure>

<h2 id="配置dao层"><a href="#配置dao层" class="headerlink" title="配置dao层"></a>配置dao层</h2><p>这个样例是我写的另一篇博客样例改编过来的，大家不知道项目结构的可以看一下我这篇博客中样例的项目结构。<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_27790011/article/details/98344732">Redis在SpringBoot中使用案例</a><br>创建dao 包，创建一个User 类,这里使用了lombok提供的@Getter 和@Setter 非常方便，代码看着也很简洁。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@Getter</span><br><span class="line">@Setter</span><br><span class="line">public class User implements Serializable &#123;</span><br><span class="line">    private static final long serialVersionUID = 1L;</span><br><span class="line">    private Long id;</span><br><span class="line">    private String userName;</span><br><span class="line">    private String password;</span><br><span class="line">    private String email;</span><br><span class="line">    private String nickname;</span><br><span class="line">    private String regTime;</span><br><span class="line"></span><br><span class="line">    public User(String email, String nickname, String password, String userName, String regTime) &#123;</span><br><span class="line">        super();</span><br><span class="line">        this.email = email;</span><br><span class="line">        this.nickname = nickname;</span><br><span class="line">        this.password = password;</span><br><span class="line">        this.userName = userName;</span><br><span class="line">        this.regTime = regTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="创建service层"><a href="#创建service层" class="headerlink" title="创建service层"></a>创建service层</h2><p>创建一个service 包，创建一个RedisService类，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">@Slf4j</span><br><span class="line">public class RedisService &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private StringRedisTemplate stringRedisTemplate;</span><br><span class="line">  </span><br><span class="line">    public boolean setUserBystringRedisTemplate(User user)&#123;</span><br><span class="line">        ValueOperations ops=stringRedisTemplate.opsForValue();</span><br><span class="line">        ops.set(user.getNickname(),JSONObject.fromObject(user).toString());</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String getUserBystringRedisTemplate(String name)&#123;</span><br><span class="line">        ValueOperations ops=stringRedisTemplate.opsForValue();</span><br><span class="line">        return JSONObject.fromObject(ops.get(name)).toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean setString(String key,String value)&#123;</span><br><span class="line">        ValueOperations ops=stringRedisTemplate.opsForValue();</span><br><span class="line">        ops.set(key,value);</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public String getString(String key)&#123;</span><br><span class="line">        ValueOperations ops=stringRedisTemplate.opsForValue();</span><br><span class="line">        return (String)ops.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建Controller层"><a href="#创建Controller层" class="headerlink" title="创建Controller层"></a>创建Controller层</h2><p>创建一个controller 包，创建一个RedisController类代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@RestController</span><br><span class="line">public class RedisController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RedisService redisService;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/setUser&quot;)</span><br><span class="line">    public String setUser()&#123;</span><br><span class="line">        User user=new User(&quot;aa@qq.com&quot;,&quot;quellan&quot;,&quot;123456&quot;,&quot;朱&quot;,new Date().getTime()+&quot;&quot;);</span><br><span class="line">        redisService.setUserBystringRedisTemplate(user);</span><br><span class="line">        return &quot;添加成功&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    @RequestMapping(&quot;/getUserByStringRedisTemplate&quot;)</span><br><span class="line">    public String  getUserByStringRedisTemplate()&#123;</span><br><span class="line">        String name=&quot;quellan&quot;;</span><br><span class="line">        return redisService.getUserBystringRedisTemplate(name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @RequestMapping(&quot;/setString&quot;)</span><br><span class="line">    public String setString(String key ,String value)&#123;</span><br><span class="line">        redisService.setString(key,value);</span><br><span class="line">        return &quot;添加成功&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @RequestMapping(&quot;/getString&quot;)</span><br><span class="line">    public String setString(String key)&#123;</span><br><span class="line">        return redisService.getString(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>到此为止，代码就已经写完啦，我们来启动项目测试一下。<br>项目启动成功之后，我们调接口看看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:9090/setString?key=a&amp;value=123</span><br><span class="line">http://localhost:9090/setString?key=b&amp;value=1qaz</span><br><span class="line">http://localhost:9090/setString?key=data&amp;value=wsxcd</span><br><span class="line">http://localhost:9090/getString?key=a</span><br><span class="line">http://localhost:9090/getString?key=data</span><br><span class="line">http://localhost:9090/setUser</span><br><span class="line">http://localhost:9090/getUser</span><br></pre></td></tr></table></figure>
<p>我就截图看其中两个<br><img src="https://img-blog.csdnimg.cn/20190903174849583.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190903174857678.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190903174943654.png" alt="在这里插入图片描述"><br>界面上没有问题啦，我们再用客户端看一下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -c -p 7000</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/2019090317530193.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>数据在集群中正常的读取是没有问题哒。</p>
<p>好了，在项目中简单使用集群就讲到这里啦，源代码我github上了，感兴趣的同学可以看下。<br><a target="_blank" rel="noopener" href="https://github.com/QuellanAn/SpringBootLearning">demo源代码</a></p>
<p>总算写完了，可能写的不是很好，大家有疑问的，可以提出来，我知道的尽量给大家解答，谢谢大家！</p>
<p>后续加油♡</p>
<p>欢迎大家关注个人公众号 “程序员爱酸奶”</p>
<p>分享各种学习资料，包含java，linux，大数据等。资料包含视频文档以及源码，同时分享本人及投递的优质技术博文。</p>
<p>如果大家喜欢记得关注和分享哟❤<br><img src="https://img-blog.csdnimg.cn/2019091922115335.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/08/22/%E4%B8%83%E3%80%81Redis%E6%8C%81%E4%B9%85%E5%8C%96%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8FRDB%E5%92%8CAOF%E7%90%86%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/22/%E4%B8%83%E3%80%81Redis%E6%8C%81%E4%B9%85%E5%8C%96%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E5%BC%8FRDB%E5%92%8CAOF%E7%90%86%E8%A7%A3/" class="post-title-link" itemprop="url">七、Redis持久化的两种方式RDB和AOF理解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-08-22 19:53:09" itemprop="dateCreated datePublished" datetime="2019-08-22T19:53:09+08:00">2019-08-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-02-25 15:14:51" itemprop="dateModified" datetime="2022-02-25T15:14:51+08:00">2022-02-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前面将了redis的主从复制以及怎么搭建，还介绍了哨兵模式以及哨兵模式的搭建。虽然操作跟上了，但是还是补一下redis的持久化。redis之所以这么流行，很大一部分原因便是持久化，断电重启数据不消失，使得redis在数据库领域中站稳了脚。前文将的主从复制其实就是依赖持久化的，如果没有持久化，这些数据都不会从主服务器备份到从服务器。下文我们就讲讲redis的持久化。</p>
<p>说起redis持久化，大家或多或少都知道一些，简单点一句话也能概括。redis通过RDB和AOF方式将数据存入磁盘，实现持久化。RDB是定期生成快照存入磁盘中，AOF是将写操作存入磁盘中。二者各有优劣，RDB 是存放数据库中数据，适合做数据备份，但是数据可能不全，最近几分钟的数据可能没有。AOF是每秒中执行一次，如果有写操作的命令就存储起来，最多只会丢失1秒钟的数据，适合做数据恢复。但是这个就不适合做数据备份了，并且由于每秒都会执行多多少少会抢占redis的内存，会影响性能。但是在实际应用中是二者是配合使用的。</p>
<p>下面就来具体的讲讲RDB和AOF吧</p>
<h1 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h1><p>RDB 的全称是 redis database. 顾名思义，RDB就是将redis数据库，用来存储数据的，所以通过RDB方式持久化就是将存在redis内存中的数据写入到RDB文件中保存到磁盘上从而实现持久化的。<br>RDB文件是一个压缩的二进制文件，通过这个文件可以还原redis数据库的数据，从而达到数据恢复的目的，借用一下《redis设计与实现》讲的这张图，途中数据库状态可以理解为redis内存中存储的数据。<br><img src="https://img-blog.csdnimg.cn/20190822110411147.png" alt="在这里插入图片描述"><br>既然RDB持久化的方式是生成RDB文件，那么这个RDB文件是怎么生成的呢？<br>RDB文件生成的方式有两种，一种是通过命令手动生成快照，还有一个是通过配置自动生成快照。下面我们来分别看看。</p>
<h2 id="通过save和bgsava命令生成RDB文件"><a href="#通过save和bgsava命令生成RDB文件" class="headerlink" title="通过save和bgsava命令生成RDB文件"></a>通过save和bgsava命令生成RDB文件</h2><p>这两个命令都是可以直接运行的。</p>
<p>save命令，会阻塞服务器进程，只有当RDB文件生成成功才会接着响应服务端的其他命令。<br><img src="https://img-blog.csdnimg.cn/20190822111713522.png" alt="在这里插入图片描述"><br>而bgsave ，既然有这个命令，肯定是和save有所不同的，bgsave 不会阻塞服务器进程，会创建一个子进程来创建RDB文件<br><img src="https://img-blog.csdnimg.cn/20190822112439225.png" alt="在这里插入图片描述"><br>但是注意的是使用bgsave命令的时候，虽然是通过子进程生成RDB文件，不会阻塞服务进程，其他的命令可以执行，但是有几个命令是不能执行的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">save </span><br><span class="line">bgsave</span><br><span class="line">bgrewriteaof</span><br></pre></td></tr></table></figure>
<p>在bgsave 期间 服务器拒绝这三个命令，主要是方式线程间竞争产生问题。</p>
<h2 id="通过配置文件自动生成RDB"><a href="#通过配置文件自动生成RDB" class="headerlink" title="通过配置文件自动生成RDB"></a>通过配置文件自动生成RDB</h2><p>初了手动执行这两个命令外，还可以在配置文件中配合参数，达到条件的时候就会自动的生成RDB<br>打开我们的配置文件redis.conf,找到如下图，这个是默认的配置。<br><img src="https://img-blog.csdnimg.cn/20190822131647656.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">save 900 1 </span><br><span class="line">表示在900秒内，如果发生了一次写操作，就触发bgsave命令生成RDB</span><br><span class="line"></span><br><span class="line">同理 </span><br><span class="line">save 300 10 在300秒内，发生了10次写操作，就触发bgsave</span><br><span class="line"></span><br><span class="line">save 60 10000  在60秒内发生了10000次写操作，就触发bgsave </span><br></pre></td></tr></table></figure>
<p>上面的这些可以进行配置，可以看到默认的设置，如果短时间内发生大量的写操作就会自动的触发bgsave ,生成RDB文件， 防止数据丢失。</p>
<p>好了，上面虽然说达到这三个条件中的一个，redis就会自动的生成RDB文件，那系统是怎样控制，又是怎样识别是否满足条件呢？<br>原来啊，服务器维持了一个dirty 计数器，以及一个lastsave属性。<br>dirty 计数器记录着从上次save&#x2F;bgave 到现在发生了多少次写操作，没进行一次写操作，计数器就加1<br>比如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set a  123</span><br><span class="line">计数器dirty 加1 </span><br><span class="line"></span><br><span class="line">set a 123 b 234 c 456</span><br><span class="line">计数器dirty 加3</span><br></pre></td></tr></table></figure>
<p>而lastsave 是unix时间戳，记录上次save或bgsave的时间。<br>有了这两个属性，就可以判断什么时候执行啦，redis服务器会周期性的执行serverCron函数,默认的话是每100毫秒执行一次。<br>这个serverCron 函数先通过当前时间减去lastsave 获取时间间隔。<br>如果dirty 大于 saveparm.chranges<br>并且时间间隔大于saveparm.seconds<br>那么就会触发bgsave 生成 RDB文件</p>
<p>其中saveparm.seconds 和saveparm.chranges  分别对应的是配置文件中设置的save 900 1等。</p>
<p>既然生成了RDB文件，我们只知道RDB是一个压缩的二进制文件，那RDB文件到底结构是什么样的呢？<br>我看了一下《redis 设计与实现》没有怎么看明白哈哈，感兴趣的可以去看看。</p>
<p>RDB方式就讲到这里了，记住RDB方式，是定时的执行bgsave 命令生成RDB文件保存在磁盘上实现持久化的。适合数据备份，用于数据恢复可能会丢失最近几分钟的数据。</p>
<h1 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h1><p>全称是append only file.  AOF 持久化的方式是通过redis服务器记录保存下所有的写命令到AOF文件存放在磁盘上，实现持久化的，看下图：<br><img src="https://img-blog.csdnimg.cn/20190822174320529.png" alt="在这里插入图片描述"><br>怎样采用AOF的方式持久化呢？<br>打开我们的配置文件，在配置文件中找到appendonly 改成yes 就可以采用AOF的方式备份了<br><img src="https://img-blog.csdnimg.cn/20190822185305746.png" alt="在这里插入图片描述"><br>我们启动redis服务，为了测试方便，我们新启的一个redis服务，数据库中没有任何key<br><img src="https://img-blog.csdnimg.cn/20190822185520265.png" alt="在这里插入图片描述"><br>我们看看appendonly.aof 也是没有任何东西的。<br><img src="https://img-blog.csdnimg.cn/20190822185617470.png" alt="在这里插入图片描述"><br>现在我们存入一个key<br><img src="https://img-blog.csdnimg.cn/20190822185725947.png" alt="在这里插入图片描述"><br>然后我们来看下aof文件的内容：<br><img src="https://img-blog.csdnimg.cn/20190822185741824.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>可以看到，初了一些$3等一些特殊符号外我们可以看到我们执行的命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select 0</span><br><span class="line">set a bbb</span><br></pre></td></tr></table></figure>
<p>但是我们一些读操作的就不会记录。由此可见，AOF 持久化就是将所有的写操作存入AOF文件中，当数据恢复的时候，执行AOF文件中的命令就可以获取数据了。</p>
<p>我们接着来看那，我向数据库中先加一个key b ,然后删除key a .<br><img src="https://img-blog.csdnimg.cn/20190822190344226.png" alt="在这里插入图片描述"><br>好了，现在我们再来看看aof 文件中是什么情况。<br><img src="https://img-blog.csdnimg.cn/2019082219043083.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>可以看到命令有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select 0</span><br><span class="line">set a bbb</span><br><span class="line">set b ddd</span><br><span class="line">del a</span><br></pre></td></tr></table></figure>
<p>所以aof 文件中包含了这四条命令，到这大家有没有发现一个问题，如果我重复的对某一个key值进行操作，那么aof文件中就会记录所有的操作命令，但是实际上只有最后一次操作才是有效的，那这个aof文件中是不是就有很多冗余的数据呢？</p>
<p>实际上是这样的，那怎么解决这个问题呢？这里就要提到一个命令啦</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BGREWRITEAOF</span><br></pre></td></tr></table></figure>
<p>和RDB中的save 以及bgsave 是类似的。不过bgrewriteaof 命令的作用是重写aof文件，为什么要重写呢，就是为了解决aof文件中冗余的问题。<br>我们先来手动执行一下这个命令<br><img src="https://img-blog.csdnimg.cn/20190822191203171.png" alt="在这里插入图片描述"><br>然后看看aof 文件中的内容<br><img src="https://img-blog.csdnimg.cn/20190822191234835.png" alt="在这里插入图片描述"><br>可以看到命令变成了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select 0</span><br><span class="line">set b ddd</span><br></pre></td></tr></table></figure>
<p>重写之后，aof的文件里的命令就是有效的啦，但是我们总不能自己手动执行bgrewriteaof 命令吧，那我们在哪里配置呢?<br>在redis.conf 配置文件中有这两个参数。<br><img src="https://img-blog.csdnimg.cn/20190822193916987.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br> auto-aof-rewrite-percentage 100<br> 当Aof log增长超过指定比例时，重写log file， 设置为0表示不自动重写Aof 日志，重写是为了使aof体积保持最小，而确保保存最完整的数据。</p>
<p>auto-aof-rewrite-min-size 64mb</p>
<p>触发aof rewrite的最小文件尺寸</p>
<p>也就是说在实际应用中，如果开启了aof 备份，可以设置这两个参数来重写AOF文件。</p>
<p>好了上面说了那么多，那redis服务怎么通过aof文件来恢复数据的呢？<br>其实很简单，就是将aof 文件中的命令一条一条的读取出来执行。看下图<br><img src="https://img-blog.csdnimg.cn/20190822194539918.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>最后再说一点嘿嘿。<br>我们在配置文件中同时启用了RDB 和AOF ,那么服务启动的时候，会在用那个文件来回复数据呢？<br>看下面这张图。<br><img src="https://img-blog.csdnimg.cn/20190822194804742.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>可以看到如果启动aof ,就会采用aof 文件来回复数据，这是为什么呢，因为AOF 文件更新的频率更高，模式一秒中一次，所以用AOF 恢复的数据更加准确。</p>
<p>好了，只有这么多了哈哈，推荐大家看看《redis 设计与实现》也不建议大家从头往后看，调感兴趣的看吧，毕竟里面还是有很多原理对我们而言也不是一定非得弄懂的，大概了解一下就行，我比较懒哈哈。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/08/21/%E5%85%AD%E3%80%81%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E6%9D%A5%E8%BF%99%E4%B9%88%E7%AE%80%E5%8D%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/21/%E5%85%AD%E3%80%81%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E6%9D%A5%E8%BF%99%E4%B9%88%E7%AE%80%E5%8D%95/" class="post-title-link" itemprop="url">六、主从复制原来这么简单</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-08-21 17:54:57" itemprop="dateCreated datePublished" datetime="2019-08-21T17:54:57+08:00">2019-08-21</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-02-25 15:14:51" itemprop="dateModified" datetime="2022-02-25T15:14:51+08:00">2022-02-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="什么是redis主从复制"><a href="#什么是redis主从复制" class="headerlink" title="什么是redis主从复制"></a>什么是redis主从复制</h1><p>总所周知redis之所以火因为它有着读取速度快，可持久化的优点。redis的持久化保证了断电或重启数据不会丢失。但仅仅这样是不够的的，持久化是将数据定期写入磁盘中，万一哪一天这一台服务器挂掉了，那所有数据依旧会丢失。为了解决这个单点故障问题，所以就有了主从复制。</p>
<p><strong>主从复制就是 将一台redis服务器的数据自动的复制到其他redis服务器上。</strong> 一台服务器出故障的概率很高，但是多台服务器同时出故障的概率就很低了吧。所谓主从主从，当然是有主服务器 (master) 和从服务器 (slave) 啦，一个 master 可以将数据复制到多个 slave，但是特别注意的是，复制是单向的，只能从 master 到 slave 。一个master 可以有多个 slave ，一个slave 也可以有多个slave ,但是一个 slave 只能从属一个master 。如下图这样就是错误的。<br><img src="https://img-blog.csdnimg.cn/20190813165546849.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h1 id="主从复制的作用及场景"><a href="#主从复制的作用及场景" class="headerlink" title="主从复制的作用及场景"></a>主从复制的作用及场景</h1><p>1、数据冗余： 主从复制实现了数据的热备份，相当于一份数据在多个服务器上存储了，是持久化之外的一种数据冗余方式，这样做的目的是以空间换取安全性。如果主服务器挂掉了，可以通过从服务将数据恢复。</p>
<p>2、故障快速修复：当 master 出现问题的时候，可以快速的将一个 slave 切换成 master 继续提供服务 ，保证项目稳定性。</p>
<p>3、读写分离： 主从复制实现读写分离非常简单，写入的时候只操作 master ，读取的时候只操作 slave ，这样读的话可以多个slave 满足项目高并发的操作。</p>
<p>4、负载均衡：既然实现了读写分离，当然就能实现负载均衡，多个 slave 承担 数据读取操作 ，从而分担 master 服务器的压力。</p>
<p>5、高可用的基石：主从复制还是哨兵模式和集群模式能够实施的基础。</p>
<p>既然主从复制有这些作用，那在实际应用中会用在哪些场景呢？</p>
<p>1、如果项目对数据安全性稳定性要求较高，就会使用主从复制搭建哨兵模式或者搭建集群。</p>
<p>2、海量数据读写，需要做读写分离提高防蚊效率，就会用到主从复制</p>
<p>3、容灾恢复，如果对数据依赖度很高，害怕数据在服务器挂掉后丢失，就可以通过主从复制防止数据丢失。</p>
<h1 id="主从复制的模式"><a href="#主从复制的模式" class="headerlink" title="主从复制的模式"></a>主从复制的模式</h1><h2 id="一主一从"><a href="#一主一从" class="headerlink" title="一主一从"></a>一主一从</h2><p>这种模式在实际应用中还是比较少见的其实，一主一从主要是实现读写分离和容灾恢复。考虑到成本的问题，所以采用两台服务器，一个redis服务器master 负责读操作，并定期的复制到 另个一服务器slave 。slave 服务器负责读写操作。在项目中配置的时候配置两个redis连接。</p>
<h2 id="一主多从"><a href="#一主多从" class="headerlink" title="一主多从"></a>一主多从</h2><p>一主多从有可以分为几种，如下图：<br><img src="https://img-blog.csdnimg.cn/20190813194440695.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>这种就是所有的 slave 都从 master 中 进行复制，这样的好处是 配置简单，所有的slave 都只用关系 master 就好了，但是要考虑到其实复制也是会侵占CPU内存的，所有的slave 都从 master 复制，可能增大 master的负荷。</p>
<p>再来看看下图：<br><img src="https://img-blog.csdnimg.cn/20190813195006162.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190813195032867.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>这种模式也是一主多从，但是和上面的所有的 slave 都从 master 复制不一样。它是使一个到两个slave 从master 直接复制，其他的slave 从这两个slave 中复制。存在层级关系。这样的好处的降低的master 服务器的负荷，但是这样会导致如果中间某个 slave 挂掉了，那依附于它的所有slave 都不能用了。</p>
<h1 id="主从复制部署"><a href="#主从复制部署" class="headerlink" title="主从复制部署"></a>主从复制部署</h1><p>这里我使用的是Ubuntu安装的redis，redis怎么安装，可以看我这篇文章<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_27790011/article/details/98057637">Redis安装</a>。<br>安装好redis后，我们启动看看是否正常</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-server /usr/local/redis/etc/redis.conf</span><br><span class="line">redis-cli -a 123456</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190814165622388.png" alt="在这里插入图片描述"><br>证明是redis是正常启动的，那现在怎么配置主从模式呢？<br>按理说主次模式的redis服务器当然是搭建在不同的服务器上，但是我们条件有限，我这里的三台redis服务都搭建在一个服务器上，只是他们监听的端口不同。</p>
<h2 id="1、修改redis-conf"><a href="#1、修改redis-conf" class="headerlink" title="1、修改redis.conf"></a>1、修改redis.conf</h2><p>我们先修改master的配置文件redis.conf 的一些配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bind 0.0.0.0    表示可以被所有机器访问。</span><br><span class="line">daemonize yes  表示可以后台启动</span><br><span class="line">port 6379</span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">logfile &quot;/usr/local/redis/logs/log_redis.log&quot;</span><br><span class="line">requirepass 123456</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190814170847658.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190814170859987.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="2、复制两份redis-config"><a href="#2、复制两份redis-config" class="headerlink" title="2、复制两份redis.config"></a>2、复制两份redis.config</h2><p>改好redis.conf 后，将&#x2F;usr&#x2F;local&#x2F;redis&#x2F;etc&#x2F; 目录下的redis.config 复制两份为redis_slave1.conf<br>redis_slave2.config<br><img src="https://img-blog.csdnimg.cn/20190814173343385.png" alt="在这里插入图片描述"></p>
<h2 id="3、修改rdis-slave1-conf"><a href="#3、修改rdis-slave1-conf" class="headerlink" title="3、修改rdis_slave1.conf"></a>3、修改rdis_slave1.conf</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bind 本机ip      表示只能本机访问</span><br><span class="line">daemonize yes </span><br><span class="line">port 6389</span><br><span class="line">pidfile /var/run/redis_6389.pid</span><br><span class="line">logfile &quot;/usr/local/redis/logs/log_redis_slaveof6389.log&quot;</span><br><span class="line">requirepass 123456 </span><br><span class="line">---上面的这些配置和redis.conf中基本一样修改一下就好了，日志是为了方便查看。下面看重点配置</span><br><span class="line"></span><br><span class="line">slaveof 192.168.252.53 6379  设置master的ip 和port</span><br><span class="line">masterauth 123456  设置master的登录密码，就是redis.conf 中配置的requirepass </span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190815090311411.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190815090259886.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="4、修改redis-slave2-conf"><a href="#4、修改redis-slave2-conf" class="headerlink" title="4、修改redis_slave2.conf"></a>4、修改redis_slave2.conf</h2><p>同样的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bind 192.168.252.53</span><br><span class="line">daemonize yes </span><br><span class="line">port 6399</span><br><span class="line">pidfile /var/run/redis_6399.pid</span><br><span class="line">logfile &quot;/usr/local/redis/logs/log_redis_slaveof6399.log&quot;</span><br><span class="line">requirepass 123456 </span><br><span class="line">slaveof 192.168.252.53 6379  </span><br><span class="line">masterauth 123456  </span><br></pre></td></tr></table></figure>
<h2 id="5、启动redis服务"><a href="#5、启动redis服务" class="headerlink" title="5、启动redis服务"></a>5、启动redis服务</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-server /usr/local/redis/etc/redis.conf</span><br><span class="line">redis-server /usr/local/redis/etc/redis_slaveof1.conf</span><br><span class="line">redis-server /usr/local/redis/etc/redis_slaveof2.conf</span><br></pre></td></tr></table></figure>
<p>查看一下进程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep redis</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190815095853692.png" alt="在这里插入图片描述"></p>
<h2 id="6、启动客户端"><a href="#6、启动客户端" class="headerlink" title="6、启动客户端"></a>6、启动客户端</h2><p>都启动来了，现在连到单个redis服务器看看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">主服务</span><br><span class="line">redis-cli -a 123456</span><br><span class="line">从服务</span><br><span class="line">redis-cli -h 192.168.252.53 -p 6389 -a 123456</span><br><span class="line">redis-cli -h 192.168.252.53 -p 6399 -a 123456</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190815100329824.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190815100527603.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="7、测试"><a href="#7、测试" class="headerlink" title="7、测试"></a>7、测试</h2><p>启动3台客户端，分别连上master和两个slave<br>在master中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set c 122</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190815104726714.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>在slave1和slave2 中分别</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get c</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190815104938516.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190815104950100.png" alt="在这里插入图片描述"><br>这样就说明你的主从复制服务已经搭建好啦。</p>
<h2 id="8、问题记录"><a href="#8、问题记录" class="headerlink" title="8、问题记录"></a>8、问题记录</h2><p>上面的是一个完美的过程搭建的主从复制的例子，但是我相信在实际搭建的时候肯定会出现各种问题，现在记录下我搭建的时候出现的问题吧<br>1、权限问题<br>在搭建好主从服务后，进入从节点查看<code>info replication</code>发现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">master_link_status:down</span><br></pre></td></tr></table></figure>
<p>表明主从节点并没有建立连接，但是但是为什么一直是down 呢，看了一下日志<br><img src="https://img-blog.csdnimg.cn/20190815102021318.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>提示不能打开rdb这个快照，当然就不能将内容复制到从节点啦，再一看这个路径，是我自己建的路径，第一反应就是权限问题，然后进这个目录一看，发现我的etc目录是root用户的。所以就修改了文件的用户和用户组。在进到etc目录下，就发现了两个快照，再去看的时候发现down变成up 了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">quellanan@quellanan-Lenovo-G400:/usr/local/redis$ sudo chown quellanan etc</span><br><span class="line">[sudo] quellanan 的密码： </span><br><span class="line">quellanan@quellanan-Lenovo-G400:/usr/local/redis$ sudo chgrp quellanan etc</span><br><span class="line">quellanan@quellanan-Lenovo-G400:/usr/local/redis$ ll</span><br><span class="line">总用量 20</span><br><span class="line">drwxr-xr-x  5 root      root      4096 8月   8 16:50 ./</span><br><span class="line">drwxr-xr-x 13 root      root      4096 8月   1 16:28 ../</span><br><span class="line">drwxr-xr-x  2 root      root      4096 8月   1 16:57 bin/</span><br><span class="line">drwxr-xr-x  2 quellanan quellanan 4096 8月  15 09:50 etc/</span><br><span class="line">drwxrwxrwx  2 root      root      4096 8月  15 09:16 logs/</span><br><span class="line">quellanan@quellanan-Lenovo-G400:/usr/local/redis$ cd etc/</span><br><span class="line">quellanan@quellanan-Lenovo-G400:/usr/local/redis/etc$ ll</span><br><span class="line">总用量 196</span><br><span class="line">drwxr-xr-x 2 quellanan quellanan  4096 8月  15 09:50 ./</span><br><span class="line">drwxr-xr-x 5 root      root       4096 8月   8 16:50 ../</span><br><span class="line">-rw-r--r-- 1 quellanan quellanan   188 8月  15 09:50 dump6389.rdb</span><br><span class="line">-rw-rw-r-- 1 quellanan quellanan   188 8月  15 09:50 dump.rdb</span><br><span class="line">-rw-rw-r-- 1 quellanan quellanan 58810 8月  14 09:18 redis.conf</span><br><span class="line">-rw-rw-r-- 1 quellanan quellanan 58882 8月  14 09:16 redis_slaveof1.conf</span><br><span class="line">-rw-r--r-- 1 quellanan quellanan 58882 8月  15 09:11 redis_slaveof2.conf</span><br></pre></td></tr></table></figure>
<p>权限问题我感觉还是挺大的，因为我们一般都是远程到服务器上操作，所以用户权限很多都需要注意。</p>
<p>2、还有一个也是发现master_link_status:down，但是并不是用户权限问题导致的，查看一下防火墙的状态，将防火墙关闭了试试。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ufw status  查看防火墙状态</span><br><span class="line">ufw enable 开启防火墙</span><br><span class="line">ufw disable 关闭防火墙</span><br></pre></td></tr></table></figure>

<p>3、在主节点插入数据的时候出现问题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set a 1qaz</span><br><span class="line">(error) MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commands that may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.</span><br></pre></td></tr></table></figure>
<p>执行这个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt;  config set stop-writes-on-bgsave-error no</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set a 123456</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get a</span><br><span class="line">&quot;123456&quot;</span><br></pre></td></tr></table></figure>

<h1 id="主从复制的原理"><a href="#主从复制的原理" class="headerlink" title="主从复制的原理"></a>主从复制的原理</h1><p>上面以及搭建了一个主从复制的样例，是一主两从的，那是怎么redis是怎么具体实现的呢？<br>在将原理之前，先来看看主从复制的几个概念。启动master后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info server</span><br><span class="line"># Server</span><br><span class="line">redis_version:4.0.9</span><br><span class="line">redis_git_sha1:00000000</span><br><span class="line">redis_git_dirty:0</span><br><span class="line">redis_build_id:514e9a11b2a67dfc</span><br><span class="line">redis_mode:standalone</span><br><span class="line">os:Linux 5.0.0-23-generic x86_64</span><br><span class="line">arch_bits:64</span><br><span class="line">multiplexing_api:epoll</span><br><span class="line">atomicvar_api:atomic-builtin</span><br><span class="line">gcc_version:7.4.0</span><br><span class="line">process_id:19688</span><br><span class="line">run_id:136de716105e54294144003a881ba29cdfbccfb2</span><br><span class="line">tcp_port:6379</span><br><span class="line">uptime_in_seconds:4515</span><br><span class="line">uptime_in_days:0</span><br><span class="line">hz:10</span><br><span class="line">lru_clock:5556386</span><br><span class="line">executable:/usr/local/redis/etc/redis-server</span><br><span class="line">config_file:/usr/local/redis/etc/redis.conf</span><br></pre></td></tr></table></figure>
<p>这个run_id 就是redis服务的唯一标识，重启redis服务号，这个run_id 会改变，多个redis客户端连接到同一个服务端，其run_id 是一样的，也就是说run_id 指的是服务端的id</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"># Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=192.168.252.53,port=6389,state=online,offset=5541,lag=1</span><br><span class="line">slave1:ip=192.168.252.53,port=6399,state=online,offset=5541,lag=0</span><br><span class="line">master_replid:f0c89aa8040dfe869de82ee623a1212240456d76</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:5541</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:5541</span><br></pre></td></tr></table></figure>
<p>其中repl_backlog_size 复制缓存区大小，默认大小为1M，如果mater_repl_offset在这个范围内，就看是部分复制，否则就开始全量复制。</p>
<h2 id="全量复制"><a href="#全量复制" class="headerlink" title="全量复制"></a>全量复制</h2><p>先看下图，图画的不是很好见谅<br><img src="https://img-blog.csdnimg.cn/20190815112038766.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>1、首先slave会向 master发送一个 psync 命令，因为是第一次，所以不知道run_id 和offset，所以传过来-1表示全量复制<br>2、 master在接收到psync 后，将run_id 和offset 发送给slave，slave存储起来<br>3、master进行bgsave生成rdb ,并将rdb 文件发送给slave<br>4、在bgsave 和send rdb 的过程中可能会产生write 的数据，那么就会把数据存到repl_back_buffer 中 并将buffer发送给slave .<br>5、slave 会清空就数据，然后加载rdb和buffer 将数据存储起来。</p>
<h2 id="部分复制"><a href="#部分复制" class="headerlink" title="部分复制"></a>部分复制</h2><p><img src="https://img-blog.csdnimg.cn/20190815131816123.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>既然是部分复制，那就是slave已经知道了master的run_id 和offset ,所以发送psync 命令带上这两个参数，master 就知道这是部分复制，然后通过偏移量将需要复制的数据发送给slave。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>主从复制的过程中既用到了全量复制也用到了部分复制，二者是相互配合使用的。看下面的流程图：<br><img src="https://img-blog.csdnimg.cn/20190815132646227.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>还有一点需要注意的是，如果master 重启了，那么它的run_id发生了改变，那么依赖它的slave都会进行一次全量复制后在进行部分复制。 </p>
<h1 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h1><h2 id="哨兵模式介绍"><a href="#哨兵模式介绍" class="headerlink" title="哨兵模式介绍"></a>哨兵模式介绍</h2><p>在将哨兵模式之前，先来说说主从复制的缺点吧。<br>如果主节点出了问题，那么主节点不在提供服务，需要手动的将从节点切换成主节点。</p>
<p>所以这个时候哨兵模式就出现啦，当主节出现故障时，Redis Sentinel会自动的发现主节点的故障并转移，并通知应用方，实现高可用。</p>
<p>下面是Redis官方文档对于哨兵功能的描述：<br>1、监控（Monitoring）：哨兵会不断地检查主节点和从节点是否运作正常。<br>2、自动故障转移（Automatic failover）：当主节点不能正常工作时，哨兵会开始自动故障转移操作，它会将失效主节点的其中一个从节点升级为新的主节点，并让其他从节点改为复制新的主节点。<br>3、配置提供者（Configuration provider）：客户端在初始化时，通过连接哨兵来获得当前Redis服务的主节点地址。<br>4、通知（Notification）：哨兵可以将故障转移的结果发送给客户端。</p>
<p>哨兵模式的结构拓扑图大概如下，也是照书上画的哈哈<br><img src="https://img-blog.csdnimg.cn/20190815152630854.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>大意就是<br>1、每一个哨兵节点会监听其他的哨兵节点以及master 和所有的slave<br>2、所有哨兵节点会定期的ping 主节点，监控是否正常<br>3、如果认为主节点出现故障的哨兵数量达到阙zhi，就判定主节点死掉，主节点就会客观下线<br>4、主节点客观下线后，哨兵节点通过选举模式在 slave 中选择出一个升级为主节点<br>5、其他的salve 指向新的主节点<br>6、原来的master 变成 slave ，并且指向新的主节点</p>
<p>引用官方哨兵模式处理流程</p>
<blockquote>
<p>每个Sentinel（哨兵）进程以每秒钟一次的频率向整个集群中的Master主服务器，Slave从服务器以及其他Sentinel（哨兵）进程发送一个 PING 命令。<br>●如果一个实例（instance）距离最后一次有效回复 PING 命令的时间超过 down-after-milliseconds 选项所指定的值， 则这个实例会被 Sentinel（哨兵）进程标记为主观下线（SDOWN）。<br>●如果一个Master主服务器被标记为主观下线（SDOWN），则正在监视这个Master主服务器的所有 Sentinel（哨兵）进程要以每秒一次的频率确认Master主服务器的确进入了主观下线状态。<br>●当有足够数量的 Sentinel（哨兵）进程（大于等于配置文件指定的值）在指定的时间范围内确认Master主服务器进入了主观下线状态（SDOWN）， 则Master主服务器会被标记为客观下线（ODOWN）。<br>●在一般情况下， 每个 Sentinel（哨兵）进程会以每 10 秒一次的频率向集群中的所有Master主服务器、Slave从服务器发送 INFO 命令。<br>●当Master主服务器被 Sentinel（哨兵）进程标记为客观下线（ODOWN）时，Sentinel（哨兵）进程向下线的 Master主服务器的所有 Slave从服务器发送 INFO 命令的频率会从 10 秒一次改为每秒一次。<br>●若没有足够数量的 Sentinel（哨兵）进程同意 Master主服务器下线， Master主服务器的客观下线状态就会被移除。若 Master主服务器重新向 Sentinel（哨兵）进程发送 PING 命令返回有效回复，Master主服务器的主观下线状态就会被移除。</p>
</blockquote>
<h2 id="哨兵模式部署"><a href="#哨兵模式部署" class="headerlink" title="哨兵模式部署"></a>哨兵模式部署</h2><p>1、首先到我们redis安装目录下，发现有sentinel.conf ，我们把它移到我们自己定义的文件夹中，和redis.conf 放在一起。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv sentinel.conf /usr/local/redis/etc/</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190815150540245.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>2、修改sentinel.conf文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line">dir /usr/local/redis/etc  </span><br><span class="line">这里默认的是“/tmp”，如果你没有这个目录的权限就需要换啦，换一个你有权限的目录，不然后果自负哈哈，我就是从坑里爬起来的</span><br><span class="line">sentinel monitor mymaster 192.168.252.53 6379 2</span><br><span class="line">sentinel auth-pass mymaster 123456</span><br><span class="line">设置监控的主节点，2是一个阈值，代表有两台或两台以上哨兵判断主节点redis不通的话就认定这个节点有问题，实行故障转移。</span><br><span class="line"></span><br><span class="line">daemonize yes 后台启动</span><br><span class="line">logfile &quot;/usr/local/redis/logs/redis_sentinel-26379.log&quot; 加上日志 ，不加也无所谓</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/20190815162950354.png" alt="在这里插入图片描述"><br>注意，这个auth-pass 要放在放在monitor 下面，不然会报错<br><img src="https://img-blog.csdnimg.cn/20190815163249800.png" alt="在这里插入图片描述"><br>配上一些参数说明：<br><img src="https://img-blog.csdnimg.cn/20190815173136849.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>3、将sentinel.conf 复制两份，分别为sentinel26389.conf,sentinel26399.conf并修改这个文件中的prot 和logfile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">port 26389</span><br><span class="line">logfile &quot;/usr/local/redis/logs/redis_sentinel-26389.log&quot; </span><br><span class="line"></span><br><span class="line">port 26399</span><br><span class="line">logfile &quot;/usr/local/redis/logs/redis_sentinel-26399.log&quot; </span><br></pre></td></tr></table></figure>
<p>4、启动哨兵</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel /usr/local/redis/etc/sentinel.conf</span><br><span class="line">redis-sentinel /usr/local/redis/etc/sentinel26389.conf</span><br><span class="line">redis-sentinel /usr/local/redis/etc/sentinel26399.conf</span><br></pre></td></tr></table></figure>
<p>查看一下，三个哨兵都已经启动了。<br><img src="https://img-blog.csdnimg.cn/20190815155415330.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>5、验证<br>先看看启动日志,，下图所示表明监控了三个节点。如果没有监控到这三个节点，证明没有配置成功。<br><img src="https://img-blog.csdnimg.cn/20190815165048966.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190815165745396.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>没有配置成功的原因可能是防火墙导致的，关闭调防火墙。还有就是如果redis-server重启过，那在sentinel.conf中生成的pid 和最后的运行添加的几行需要删除掉，下图这些。然后重新运行。<br><img src="https://img-blog.csdnimg.cn/2019081516595840.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190815170006704.png" alt="在这里插入图片描述"></p>
<p>好的，日志看的没有问题，如果不想看日志，我们来这样验证，我们已经启动了三个redis服务，三个哨兵。我们现在把 master 杀死看看是什么情况。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill -9 19688</span><br></pre></td></tr></table></figure>
<p>看日志，三个哨兵的监控日志基本上是一样的，下图贴出三个哨兵的日志，我们就看一下第一个哨兵的日志分析一下。<br><img src="https://img-blog.csdnimg.cn/20190816112211295.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>看上图，启动哨兵的时候，监控到了master 6379 和两个slave 6389和6399，以及另外两个哨兵，26389和26399.<br>然后sdown master mymaster 192.168.252.53 6379 表示刚刚我们杀死的master服务。<br>这个时候有一个哨兵表示其主观下线，等到odown 达到我们设置的2时，表明有两个哨兵表示其主观下线，那么就认为6379这个master 已经客观下线。<br>然后通过选举，选取26399 这个哨兵为这三个哨兵的领导者(leader)。<br>23699 这个leader 在salve中选择6399转为 master<br>将6389 这个slave 指向新的 master 6399<br>这个时候重启6379 这个redis服务<br>将6379 这个slave指向新的master 6399<br><img src="https://img-blog.csdnimg.cn/20190816112223157.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190816112236544.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>好，下面我们来看看界面<br><img src="https://img-blog.csdnimg.cn/20190816115256106.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20190816115310470.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>可以看到master已经切换到6399 服务了，现在我们再切换一下，看下面这张图应该很清晰啦<br><img src="https://img-blog.csdnimg.cn/20190816115633540.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>到此为止，哨兵模式就搭建好啦，当 master 挂掉时，会自动的将一个slave 升级成 master 并将其他的 slave 指向新的master ，从新把原来的master启动后，会变成slave 执行新的master 。</p>
<h1 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1><p>写到这，其实还有一部分没有写完，但是感觉实在是太长了，就先写这么多吧，还差一个怎么在项目中使用搭建的哨兵模式，也就是集群模式，怎么做到读写分离，实现高可用的。<br>因为前面这些讲的都是在redis数据库上直接操作，那现在部署好了，怎么在项目代码中使用呢，所以下篇接着将在项目中怎么使用redis集群。喜欢的小伙伴可以持续关注啦。 </p>
<p>好了，上面都是题外话，下面总结一下这篇文章吧。<br>1、主从复制是什么以及作用。<br>2、怎样部署一个主从复制（案例一主两从）<br>3、怎样部署哨兵模式（三哨兵）<br>其实我感觉如果你通过这篇文章学会了这三点，就够了，其他的看看当了解。</p>
<p>谢谢大家</p>
<p>后续加油♡</p>
<p>欢迎大家关注个人公众号 “程序员爱酸奶”</p>
<p>分享各种学习资料，包含java，linux，大数据等。资料包含视频文档以及源码，同时分享本人及投递的优质技术博文。</p>
<p>如果大家喜欢记得关注和分享哟❤<br><img src="https://img-blog.csdnimg.cn/2019091922115335.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/08/08/%E4%BA%94%E3%80%81redis%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E4%BB%A5%E5%8F%8A%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/08/08/%E4%BA%94%E3%80%81redis%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF%E4%BB%A5%E5%8F%8A%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">五、redis配置信息以及常用命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-08-08 18:56:22" itemprop="dateCreated datePublished" datetime="2019-08-08T18:56:22+08:00">2019-08-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-02-25 15:14:51" itemprop="dateModified" datetime="2022-02-25T15:14:51+08:00">2022-02-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本来不打算写这篇的，因为网上有很多这种的，最后想想，既然打算做一个redis系列，还是把这一篇补上，刚好这段时间有个同事做了一个redis的基础培训，整理的很好，就拿来借用一下，但是我们实际开发中其实用不了那么多，我们对这些配置和命令有个大概的了解就行，也不用死记硬背的把每个命令和配置记住，当然诸位如果能记住那就更好啦。<br>关于redis的介绍就不多说了，持久化，速度快，单线程，基于内存。</p>
<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><p>redis的配置文件是redis.conf。我们上次安装的时候把它放在了<code>/use/local/redis/etc/redis.conf</code>,默认的配置文件应该在安装目录下的src&#x2F;redis.conf<br>配置文件的内容有很多</p>
<ol>
<li><p>Redis默认不是以守护进程的方式运行，可以通过该配置项修改，使用yes启用守护进程<br> daemonize no</p>
</li>
<li><p>当Redis以守护进程方式运行时，Redis默认会把pid写入&#x2F;var&#x2F;run&#x2F;redis.pid文件，可以通过pidfile指定<br> pidfile &#x2F;var&#x2F;run&#x2F;redis.pid</p>
</li>
<li><p>指定Redis监听端口，默认端口为6379<br> port 6379</p>
</li>
<li><p>绑定的主机地址<br>bind 127.0.0.1</p>
</li>
<li><p>当 客户端闲置多长时间后关闭连接，如果指定为0，表示关闭该功能<br> timeout 300</p>
</li>
<li><p>指定日志记录级别，Redis总共支持四个级别：debug、verbose、notice、warning，默认为verbose<br> loglevel verbose</p>
</li>
<li><p>日志记录方式，默认为标准输出，如果配置Redis为守护进程方式运行，而这里又配置为日志记录方式为标准输出，则日志将会发送给&#x2F;dev&#x2F;null，如果需要存储日志可以设置具体文件名。<br> logfile “&#x2F;home&#x2F;gdmt&#x2F;mastercom&#x2F;redis-4.0.5&#x2F;bin&#x2F;log_master.log”</p>
</li>
<li><p>设置数据库的数量，默认数据库为0，可以使用SELECT <dbid>命令在连接上指定数据库id<br> databases 16</p>
</li>
<li><p>指定在多长时间内，有多少次更新操作，就将数据同步到数据文件，可以多个条件配合<br> save <seconds> <changes><br> Redis默认配置文件中提供了三个条件：<br> save 900 1<br> save 300 10<br> save 60 10000<br> 分别表示900秒（15分钟）内有1个更改，300秒（5分钟）内有10个更改以及60秒内有10000个更改。</p>
</li>
<li><p>指定存储至本地数据库时是否压缩数据，默认为yes，Redis采用LZF压缩，如果为了节省CPU时间，可以关闭该选项，但会导致数据库文件变的巨大<br>rdbcompression yes</p>
</li>
<li><p>指定本地数据库文件名，默认值为dump.rdb<br>dbfilename dump.rdb</p>
</li>
<li><p>指定本地数据库存放目录<br>dir “&#x2F;home&#x2F;mastercom&#x2F;redis-4.0.5&#x2F;bin”</p>
</li>
<li><p>设置当本机为slav服务时，设置master服务的IP地址及端口，在Redis启动时，它会自动从master进行数据同步<br>slaveof <masterip> <masterport></p>
</li>
<li><p>当master服务设置了密码保护时，slav服务连接master的密码<br>masterauth <master-password></p>
</li>
<li><p>设置Redis连接密码，如果配置了连接密码，客户端在连接Redis时需要通过AUTH <password>命令提供密码，默认关闭<br>requirepass foobared</p>
</li>
<li><p>设置同一时间最大客户端连接数，默认无限制，Redis可以同时打开的客户端连接数为Redis进程可以打开的最大文件描述符数，如果设置 maxclients 0，表示不作限制。当客户端连接数到达限制时，Redis会关闭新的连接并向客户端返回max number of clients reached错误信息<br>maxclients 10000</p>
</li>
<li><p>指定Redis最大内存限制，Redis在启动时会把数据加载到内存中，达到最大内存后，Redis会先尝试清除已到期或即将到期的Key，当此方法处理 后，仍然到达最大内存设置，将无法再进行写入操作，但仍然可以进行读取操作。Redis新的vm机制，会把Key存放内存，Value会存放在swap区<br>maxmemory <bytes></p>
</li>
<li><p>指定是否在每次更新操作后进行日志记录，Redis在默认情况下是异步的把数据写入磁盘，如果不开启，可能会在断电时导致一段时间内的数据丢失。因为 redis本身同步数据文件是按上面save条件来同步的，所以有的数据会在一段时间内只存在于内存中。默认为no<br>appendonly no</p>
</li>
<li><p>指定更新日志文件名，默认为appendonly.aof<br> appendfilename appendonly.aof</p>
</li>
</ol>
<h2 id="总结一下"><a href="#总结一下" class="headerlink" title="总结一下"></a>总结一下</h2><p>上面那么多配置，我和大家一样没有都记住，只是了解一个大概，要用的时候能查就行，上面很多都是默认配置，感觉一般要设置的下面这几个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes</span><br><span class="line">port  端口号</span><br><span class="line">bind ip </span><br><span class="line">slaveof &lt;masterip&gt; &lt;masterport&gt;</span><br><span class="line">requirepass foobared</span><br></pre></td></tr></table></figure>

<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><h2 id="针对key的命令"><a href="#针对key的命令" class="headerlink" title="针对key的命令"></a>针对key的命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">exists(key)：确认一个key是否存在</span><br><span class="line">del(key)：删除一个key</span><br><span class="line">type(key)：返回值的类型</span><br><span class="line">keys(pattern)：返回满足给定pattern的所有key</span><br><span class="line">randomkey：随机返回key空间的一个</span><br><span class="line">keyrename(oldname, newname)：重命名key</span><br><span class="line">dbsize：返回当前数据库中key的数目</span><br><span class="line">expire：设定一个key的活动时间（s）</span><br><span class="line">ttl：获得一个key的活动时间</span><br><span class="line">move(key, dbindex)：移动当前数据库中的key到dbindex数据库</span><br><span class="line">flushdb：删除当前选择数据库中的所有key--慎用</span><br><span class="line">flushall：删除所有数据库中的所有key--慎用</span><br></pre></td></tr></table></figure>
<p>真正常用的就</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">exists key</span><br><span class="line">del key</span><br><span class="line">type key</span><br><span class="line">dbsize</span><br><span class="line">expire</span><br></pre></td></tr></table></figure>
<h2 id="针对String类型的命令"><a href="#针对String类型的命令" class="headerlink" title="针对String类型的命令"></a>针对String类型的命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">set(key, value)：给数据库中名称为key的string赋予值value</span><br><span class="line">get(key)：返回数据库中名称为key的string的value</span><br><span class="line">getset(key, value)：给名称为key的string赋予上一次的value</span><br><span class="line">mget(key1, key2,…, key N)：返回库中多个string的value</span><br><span class="line">setnx(key, value)：如果key不存在，添加string，名称为key，值为value</span><br><span class="line">setex(key, time, value)：向库中添加string，设定过期时间time</span><br><span class="line">mset(key N, value N)：批量设置多个string的值</span><br><span class="line">msetnx(key N, value N)：如果所有名称为key 的string都不存在 就添加</span><br><span class="line">incr(key)：名称为key的string增1操作</span><br><span class="line">incrby(key, integer)：名称为key的string增加integer</span><br><span class="line">decr(key)：名称为key的string减1操作</span><br><span class="line">decrby(key, integer)：名称为key的string减少integer</span><br><span class="line">append(key, value)：名称为key的string的值附加value</span><br><span class="line">substr(key, start, end)：返回名称为key的string的value的子串</span><br></pre></td></tr></table></figure>
<p>我认为常用的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">set</span><br><span class="line">get </span><br><span class="line">mset</span><br><span class="line">mget</span><br><span class="line">incr</span><br><span class="line">decr</span><br></pre></td></tr></table></figure>

<h2 id="针对List类型"><a href="#针对List类型" class="headerlink" title="针对List类型"></a>针对List类型</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">rpush(key, value)：在名称为key的list尾添加一个值为value的元素</span><br><span class="line">lpush(key, value)：在名称为key的list头添加一个值为value的 元素</span><br><span class="line">llen(key)：返回名称为key的list的长度</span><br><span class="line">lrange(key, start, end)：返回名称为key的list中start至end之间的元素,-1是最后一位的索引</span><br><span class="line">ltrim(key, start, end)：截取名称为key的list</span><br><span class="line">lindex(key, index)：返回名称为key的list中index位置的元素</span><br><span class="line">lset(key, index, value)：给名称为key的list中index位置的元素赋值</span><br><span class="line">lrem(key, count, value)：删除count个key的list中值为value的元素</span><br><span class="line">lpop(key)：返回并删除名称为key的list中的首元素</span><br><span class="line">rpop(key)：返回并删除名称为key的list中的尾元素</span><br><span class="line">blpop(key1, key2,… key N, timeout)：lpop命令的block版本。</span><br><span class="line">brpop(key1, key2,… key N, timeout)：rpop的block版本。</span><br><span class="line">rpoplpush(srckey, dstkey)：返回并删除名称为srckey的list的尾元素，并将该元素添加到名称为dstkey的list的头部</span><br></pre></td></tr></table></figure>
<p>一样我认为常用的,但是感觉list 用的不多</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rpush</span><br><span class="line">lpush</span><br><span class="line">rlang</span><br><span class="line">llen</span><br><span class="line">lpop</span><br><span class="line">rpop</span><br></pre></td></tr></table></figure>
<h2 id="针对set类型"><a href="#针对set类型" class="headerlink" title="针对set类型"></a>针对set类型</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sadd(key, member)：向名称为key的set中添加元素member</span><br><span class="line">srem(key, member) ：删除名称为key的set中的元素member</span><br><span class="line">spop(key) ：随机返回并删除名称为key的set中一个元素</span><br><span class="line">smove(srckey, dstkey, member) ：移到集合元素</span><br><span class="line">scard(key) ：返回名称为key的set的基数</span><br><span class="line">sismember(key, member) ：member是否是名称为key的set的元素</span><br><span class="line">sinter(key1, key2,…key N) ：求交集</span><br><span class="line">sinterstore(dstkey, (keys)) ：求交集并将交集保存到dstkey的集合</span><br><span class="line">sunion(key1, (keys)) ：求并集</span><br><span class="line">sunionstore(dstkey, (keys)) ：求并集并将并集保存到dstkey的集合</span><br><span class="line">sdiff(key1, (keys)) ：求差集</span><br><span class="line">sdiffstore(dstkey, (keys)) ：求差集并将差集保存到dstkey的集合</span><br><span class="line">smembers(key) ：返回名称为key的set的所有元素</span><br><span class="line">srandmember(key) ：随机返回名称为key的set的一个元素</span><br></pre></td></tr></table></figure>
<p>感觉这个是用的最少了，很多都记不住，就知道添加和读取.zset 和set的都用的很少</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sadd</span><br><span class="line">smembers</span><br><span class="line"></span><br><span class="line">sadd</span><br><span class="line">zrange</span><br></pre></td></tr></table></figure>

<h2 id="针对Hash类型"><a href="#针对Hash类型" class="headerlink" title="针对Hash类型"></a>针对Hash类型</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">hset(key, field, value)：向名称为key的hash中添加元素field</span><br><span class="line">hget(key, field)：返回名称为key的hash中field对应的value</span><br><span class="line">hmget(key, (fields))：返回名称为key的hash中field i对应的value</span><br><span class="line">hmset(key, (fields))：向名称为key的hash中添加元素field </span><br><span class="line">hincrby(key, field, integer)：将名称为key的hash中field的value增加integer</span><br><span class="line">hexists(key, field)：名称为key的hash中是否存在键为field的域</span><br><span class="line">hdel(key, field)：删除名称为key的hash中键为field的域</span><br><span class="line">hlen(key)：返回名称为key的hash中元素个数</span><br><span class="line">hkeys(key)：返回名称为key的hash中所有键</span><br><span class="line">hvals(key)：返回名称为key的hash中所有键对应的value</span><br><span class="line">hgetall(key)：返回名称为key的hash中所有的键（field）及其对应的value</span><br></pre></td></tr></table></figure>
<p>hash类型用的比较多，特别是对象存储时候，基本上都是用hash 存储的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hset</span><br><span class="line">hget</span><br><span class="line">hmset</span><br><span class="line">hmget</span><br></pre></td></tr></table></figure>


<p>后续加油♡</p>
<p>欢迎大家关注个人公众号 “程序员爱酸奶”</p>
<p>分享各种学习资料，包含java，linux，大数据等。资料包含视频文档以及源码，同时分享本人及投递的优质技术博文。</p>
<p>如果大家喜欢记得关注和分享哟❤<br><img src="https://img-blog.csdnimg.cn/2019091922115335.jpeg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzI3NzkwMDEx,size_16,color_FFFFFF,t_70" alt="file"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
